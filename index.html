<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Manifesto - Confess Wall</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Lexend:wght@700&display=swap" rel="stylesheet">
    <style>
        /* CSS Variables for easy theme management */
        :root {
            --background-color: #121212;
            --surface-color: #1e1e1e;
            --primary-color: #fde047; /* Brighter Yellow */
            --primary-text-color: #e5e5e5;
            --secondary-text-color: #a3a3a3;
            --card-background: #2a2a2a;
            --border-color: #404040;
            --font-main: 'Inter', sans-serif;
            --font-heading: 'Lexend', sans-serif;
        }

        /* Custom Scrollbar for the main page */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--surface-color);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #ffc107;
        }

        body {
            background: var(--background-color);
            color: var(--primary-text-color);
            font-family: var(--font-main);
            margin: 0;
            padding: 40px 16px;
            text-align: center;
            display: flex;
            flex-direction: column; /* Changed to column to stack content */
            justify-content: flex-start; /* Align content to the top */
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
            overflow-y: auto; /* Allow body to scroll if content exceeds viewport */
        }

        /* CSS to prevent body scrolling when a modal is open */
        body.modal-open {
            overflow: hidden;
        }

        .container {
            max-width: 400px;
            width: 100%;
            margin: 0 auto;
        }

        h2 {
            font-family: var(--font-heading);
            font-size: 28px;
            /* Updated color to grey and added a subtle yellow glow */
            color: var(--card-background); /* Grey color similar to card background */
            text-shadow: 0 0 8px rgba(253, 224, 71, 0.6), /* Yellow glow */
                         0 0 15px rgba(253, 224, 71, 0.3); /* Fainter glow for depth */
            margin-bottom: 16px;
        }

        .poem {
            /* REVISED STYLING FOR "TEGAS" */
            font-style: normal; /* Removed italic */
            color: var(--secondary-text-color);
            line-height: 1.6; /* Adjusted line height for readability */
            margin-bottom: 32px;
            font-size: 16px; /* Slightly larger font size */
            font-weight: bold; /* Made the font bold */
            white-space: pre-line; /* Preserves line breaks from HTML */
            padding: 0 8px; /* Added slight horizontal padding to prevent text from touching edges */
        }

        .question {
            font-size: 18px;
            font-weight: bold;
            margin: 32px 0 16px;
            color: var(--primary-text-color);
            text-align: center;
        }

        /* Style for the extra bold yellow text */
        .question .highlight-text {
            color: var(--primary-color);
            font-weight: bolder;
        }

        /* Confess list container - now responsible for its own scrolling and hidden scrollbar */
        .confess-list {
            background: var(--surface-color);
            border-radius: 16px;
            max-height: 400px; /* DITINGGIKAN 1/4 DARI 320px */
            overflow-y: auto;
            padding: 8px;
            padding-bottom: 50px; /* Adjusted padding to make space for sticky button and cover content */
            margin-bottom: 32px;
            border: 1px solid var(--border-color);
            /* Hide scrollbar for this specific section */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none;  /* IE and Edge */
            position: relative; /* Needed for sticky positioning of child */
        }
        .confess-list::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera*/
        }

        .confess-post {
            background: var(--card-background);
            padding: 16px;
            border-radius: 12px;
            margin: 8px;
            text-align: left;
            border: 1px solid transparent;
            transition: all 0.3s ease;
            margin-bottom: 16px; /* Added margin for spacing between posts */
        }
        .confess-post:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            border-color: var(--primary-color);
        }

        .actions {
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 14px;
            margin-top: 12px;
            color: var(--secondary-text-color);
        }
        .actions span {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .actions button {
            background: none;
            border: none;
            color: var(--secondary-text-color);
            cursor: pointer;
            padding: 4px 8px; /* Adjusted padding for reaction buttons */
            border-radius: 8px;
            transition: background 0.2s ease, color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .actions button:hover {
            background: rgba(253, 224, 71, 0.1); /* Subtle hover background */
            color: var(--primary-color);
        }
        .actions button.active { /* Style for active reaction */
            color: var(--primary-color);
            background: rgba(253, 224, 71, 0.2);
        }
        .actions button svg {
            width: 16px;
            height: 16px;
        }

        /* Comment Section Styles (for modal) */
        .comments-section-modal {
            margin-top: 20px;
            padding-top: 15px;
        }
        .comments-list-modal {
            flex-grow: 1; /* Allow comments list to take available space */
            overflow-y: auto;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 15px;
            background: var(--background-color);
            text-align: left;
            display: flex;
            flex-direction: column;
            gap: 10px;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none;  /* IE and Edge */
        }
        .comments-list-modal::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera*/
        }
        .comment-item {
            background: var(--card-background); /* Use card background for comment items */
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 13px;
            color: var(--primary-text-color);
            text-align: left;
        }
        .comment-item strong {
            color: var(--primary-color);
            margin-right: 5px;
        }
        .comment-input-wrapper {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .comment-input-wrapper input {
            flex-grow: 1;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--background-color);
            color: var(--primary-text-color);
            font-size: 14px;
        }
        .comment-input-wrapper button {
            width: auto; /* Override 100% width from general button style */
            padding: 8px 15px;
            font-size: 14px;
            border-radius: 8px;
        }
        .comment-input-wrapper input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 5px rgba(253, 224, 71, 0.2);
        }
        .comment-char-count {
            font-size: 12px;
            color: var(--secondary-text-color);
            text-align: right;
            margin-top: 4px;
        }
        .comment-char-count.warning {
            color: red;
        }

        /* Confess form now sticky inside confess-list */
        .confess-form {
            background: var(--surface-color);
            padding: 10px; /* Adjusted padding to make it tighter */
            border-radius: 16px; /* Keep top radius */
            border-bottom-left-radius: 16px; /* Match list bottom radius */
            border-bottom-right-radius: 16px; /* Match list bottom radius */
            border: 1px solid var(--border-color);
            border-top: 1px solid var(--border-color); /* Add top border to separate from posts */
            margin-bottom: 0; /* Remove margin as it's sticky */
            position: sticky; /* Make it stick */
            bottom: -40px; /* <--- EDIT DI SINI UNTUK MENURUNKAN POSISI */
            z-index: 10; /* Ensure it's above scrolling posts */
            box-sizing: border-box; /* Include padding and border in element's total width and height */
            width: calc(100% - 16px); /* Adjust width to fit inside confess-list padding */
            left: 8px; /* Align with left padding of confess-list */
        }

        button {
            width: 100%;
            background: var(--primary-color);
            color: #111;
            border: none;
            padding: 14px;
            font-weight: bold;
            font-size: 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: var(--font-heading);
        }
        button:hover {
            background: #ffc107;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(253, 224, 71, 0.2);
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .email-section {
            margin-top: 40px;
            padding: 24px;
            background: var(--surface-color);
            border-radius: 16px;
            border: 1px solid var(--border-color);
        }
        .email-section p {
            margin: 0 0 16px 0;
            font-size: 14px;
            color: var(--primary-text-color);
        }

        .email-section input {
            width: 100%;
            box-sizing: border-box;
            padding: 14px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: var(--background-color);
            color: var(--primary-text-color);
            font-size: 16px;
            font-family: var(--font-main);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            text-align: center;
        }
        .email-section input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 10px rgba(253, 224, 71, 0.2);
        }

        .email-section button {
            margin-top: 16px;
        }

        /* Custom Modal Styles (for confession input and success message) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0; /* Reverted */
            visibility: hidden; /* Reverted */
            transition: opacity 0.3s ease, visibility 0.3s ease; /* Reverted */
            z-index: 1000;
        }
        .modal-overlay.show {
            opacity: 1; /* Reverted */
            visibility: visible; /* Reverted */
        }
        .modal-content {
            background: var(--surface-color);
            padding: 24px;
            border-radius: 16px;
            width: 90%;
            max-width: 380px;
            text-align: center;
            border: 1px solid var(--border-color);
            transform: scale(0.9); /* Reverted */
            transition: transform 0.3s ease; /* Reverted */
            position: relative;
        }
        .modal-overlay.show .modal-content { /* Re-added this block */
            transform: scale(1);
        }
        .modal-content h3 {
            margin-top: 0;
            margin-bottom: 16px;
            color: var(--primary-color);
            font-family: var(--font-heading);
        }
        .modal-content p {
            margin-bottom: 20px;
            color: var(--secondary-text-color);
        }
        .modal-textarea {
            width: 100%;
            box-sizing: border-box;
            background: var(--background-color);
            color: var(--primary-text-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 14px;
            font-size: 16px;
            resize: none;
            margin-bottom: 16px;
            font-family: var(--font-main);
        }
        .alter-input-wrapper {
            display: flex;
            align-items: center;
            background: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding-left: 14px;
            margin-bottom: 20px;
        }
        .alter-input-wrapper span {
            color: var(--secondary-text-color);
            font-size: 16px;
        }
        .modal-input {
            flex-grow: 1;
            border: none;
            background: transparent;
            color: var(--primary-text-color);
            font-size: 16px;
            padding: 14px;
        }
        .modal-input:focus {
            outline: none;
        }
        .modal-actions {
            display: flex;
            gap: 12px;
        }
        .modal-actions button { /* Specific style for buttons within modal-actions */
            width: 100%; /* Ensure buttons inside modal-actions take full width */
        }


        /* Quotes Section Styles */
        .quotes-section {
            margin-bottom: 32px;
        }
        .quotes-slider-wrapper {
            position: relative;
            width: 100%;
        }
        .quotes-slider {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
        }
        .quotes-slider::-webkit-scrollbar {
            display: none; /* Safari and Chrome */
        }
        .quote-slide {
            flex: 0 0 100%;
            width: 100%;
            scroll-snap-align: center;
            padding: 0;
            box-sizing: border-box;
        }
        .quote-slide img { /* Updated to target img instead of svg */
            width: 100%;
            height: auto;
            border-radius: 16px;
            display: block; /* Remove extra space below image */
        }
        .slider-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 100%;
            left: 0;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
        }
        .slider-nav button {
            pointer-events: all;
            background: rgba(0,0,0,0.3);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .slider-nav button#prevQuote {
            transform: translateX(-50%);
        }
        .slider-nav button#nextQuote {
            transform: translateX(50%);
        }
        .quote-actions {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-top: 16px;
        }
        .quote-actions button {
            background: none;
            border: none;
            color: var(--secondary-text-color);
            cursor: pointer;
            padding: 8px;
            display: flex;
            flex-direction: column; /* Stack icon and text vertically */
            align-items: center; /* Center horizontally */
            justify-content: center; /* Center vertically */
            gap: 4px; /* Reduced gap between icon and text */
            font-size: 14px;
            opacity: 0.8;
            transition: opacity 0.2s ease;
        }
        .quote-actions button:hover {
            opacity: 1;
            color: var(--primary-text-color);
        }
        .quote-actions svg {
            width: 20px;
            height: 20px;
        }

        /* Toast/Snackbar message for "Copied!" and success messages */
        .toast-message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--primary-color);
            color: #111;
            padding: 10px 20px;
            border-radius: 8px;
            font-family: var(--font-main);
            font-weight: bold;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            z-index: 1001;
        }
        .toast-message.show {
            opacity: 1;
            visibility: visible;
        }

        /* Talk to Selfie specific styles */
        .talk-to-selfie-modal-content {
            max-width: 500px; /* Slightly wider for chat */
            height: 80vh; /* Take more vertical space */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .chat-history {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 15px;
            background: var(--background-color);
            text-align: left;
            display: flex;
            flex-direction: column;
            gap: 10px;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none;  /* IE and Edge */
        }
        .chat-history::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera*/
        }

        .chat-message {
            padding: 8px 12px;
            border-radius: 12px;
            max-width: 85%;
        }

        .chat-message.user {
            background: #4a4a4a;
            color: var(--primary-text-color);
            align-self: flex-end; /* Align to right */
            border-bottom-right-radius: 4px;
        }

        .chat-message.selfie {
            background: var(--primary-color);
            color: #111;
            align-self: flex-start; /* Align to left */
            border-bottom-left-radius: 4px;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 10px;
        }

        .chat-input-wrapper input {
            flex-grow: 1;
            padding: 12px;
            border-radius: 12px;
            border: 11px solid var(--border-color);
            background: var(--background-color);
            color: var(--primary-text-color);
            font-size: 16px;
        }
        .chat-input-wrapper input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 5px rgba(253, 224, 71, 0.2);
        }

        .chat-input-wrapper button {
            width: auto;
            padding: 12px 20px;
            font-size: 16px;
        }
        .loading-indicator {
            text-align: center;
            margin-top: 10px;
            font-style: italic;
            color: var(--secondary-text-color);
        }

        /* Floating Action Button (FAB) styles */
        .floating-action-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: var(--primary-color);
            color: #111; /* Dark text for yellow background */
            border: none;
            border-radius: 50%; /* Make it circular */
            box-shadow: 0 4px 15px rgba(0,0,0,0.4); /* Subtle shadow for floating effect */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 30px; /* Large emoji size */
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 999; /* Ensure it's above other content */
            font-family: 'Inter', sans-serif; /* Use Inter for emoji */
            font-weight: normal; /* Reset font weight */
        }

        .floating-action-button:hover {
            background: #ffc107;
            transform: translateY(-3px) scale(1.05); /* Slight lift and scale on hover */
            box-shadow: 0 6px 20px rgba(0,0,0,0.5);
        }

        /* New style for character count */
        .char-count {
            font-size: 12px;
            color: var(--secondary-text-color);
            text-align: right;
            margin-top: -10px; /* Adjust margin to be closer to textarea */
            margin-bottom: 16px; /* Space before next element */
        }
        .char-count.warning {
            color: red;
        }

        /* Global Loading Overlay */
        #globalLoadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            color: var(--primary-color);
            font-size: 20px;
            font-weight: bold;
            flex-direction: column;
            gap: 15px;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s, opacity 0.3s linear;
        }

        #globalLoadingOverlay.show {
            visibility: visible;
            opacity: 1;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body>
    <div id="globalLoadingOverlay">
        <div class="spinner"></div>
        <p id="globalLoadingMessage">Memuat...</p>
    </div>

    <div class="container">
        <h2>Manifesto Selfify</h2>
        <div class="poem">
            Sekarang Dunia makin berisik, orang makin toxic
            dan Sosmed? Udah gak asik.

            Kalau hati lo gak terusik, 
            Mungkin lo beneran lagi sakit.

            Dan ketika elo Lelah ngejar validasi?

            <span style="color: var(--primary-color);">"Selfify hadir bukan buat pelarian,
            tapi tempat lo pulang ke diri lo sendiri."</span>

            Karena hidup gak cuma buat dilewatin
            but dijalanin dengan arah & makna.
        </div>
        
        <div class="quotes-section">
            <div class="quotes-slider-wrapper">
                <div class="quotes-slider" id="quotesSlider">
                    <!-- Quotes will be dynamically loaded as images here -->
                </div>
                <div class="slider-nav">
                    <button id="prevQuote">‹</button>
                    <button id="nextQuote">›</button>
                </div>
            </div>
            <div class="quote-actions">
                <button id="shareQuoteBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M7.217 10.907a2.25 2.25 0 1 0 0 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186 9.566-5.314m-9.566 7.5 9.566 5.314m0 0a2.25 2.25 0 1 0 3.935 2.186 2.25 2.25 0 0 0-3.935-2.186Zm0-12.814a2.25 2.25 0 1 0 3.933-2.186 2.25 2.25 0 0 0-3.933 2.186Z" /></svg>
                </button>
                <button id="downloadQuoteBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                    Download
                </button>
            </div>
        </div>

        <div class="question">Hal apa yang paling lo gak mau<br/><span class="highlight-text">orang tau tentang elo?</span></div>

        <div class="confess-list" id="confessList">
            <!-- Posts are dynamically added -->
            <div id="loadingMessage" style="color: var(--secondary-text-color); padding: 20px;">Memuat pengakuan...</div>
            
            <!-- Confess form now sticky inside confess-list -->
            <div class="confess-form">
                <button id="openConfessModalBtn">Curhat? Confess? Boleh banget.</button>
            </div>
        </div>

        <div class="email-section">
            <p>Drop email lo, and let’s be part of the first <b style="color: var(--primary-color);">Selfify</b> circle. We’ve got cool features yang gak cuman keren, tapi juga super relatable—tailored just for you.</p>
            <input type="email" id="emailInput" placeholder="you@email.com" />
            <button id="submitEmailBtn">Kirim 🔔</button>
        </div>
    </div>

    <!-- Floating Talk to Selfie Button -->
    <button id="openTalkToSelfieModalBtn" class="floating-action-button">🤖</button>

    <!-- Custom Modal for New Confession -->
    <div class="modal-overlay" id="confessModal">
        <div class="modal-content">
            <h3>Buat Pengakuan</h3>
            <textarea id="modalConfessText" class="modal-textarea" rows="5" placeholder="Tulis pengakuan lo di sini..."></textarea>
            <div class="char-count" id="modalConfessCharCount">0/500</div> <!-- New character counter -->
            <div class="alter-input-wrapper">
                <span>@</span>
                <input type="text" id="modalAlterName" class="modal-input" placeholder="nama_alter_lo" maxlength="20">
            </div>
            <div class="char-count" id="modalAlterNameCharCount">0/20</div> <!-- New alter name character counter -->
            <div class="modal-actions">
                <button id="cancelConfess" style="background: #444;">Batal</button>
                <button id="submitConfess">Kirim</button>
            </div>
        </div>
    </div>

    <!-- Custom Modal for Success Message -->
    <div class="modal-overlay" id="successModal">
        <div class="modal-content">
            <h3>Terkirim! 🙏</h3>
            <p>Pengakuan lo udah aman di sini. Terima kasih sudah berbagi.</p>
            <button id="closeSuccessModal">Tutup</button>
        </div>
    </div>

    <!-- Custom Modal for Error Message -->
    <div class="modal-overlay" id="errorModal">
        <div class="modal-content">
            <h3>Error! 😔</h3>
            <p id="errorMessage">Terjadi kesalahan saat menyimpan pengakuan Anda. Silakan coba lagi.</p>
            <button id="closeErrorModal">Tutup</button>
        </div>
    </div>

    <!-- Talk to Selfie Modal -->
    <div class="modal-overlay" id="talkToSelfieModal">
        <div class="modal-content talk-to-selfie-modal-content">
            <h3>Talk to Selfie 🤖</h3>
            <div class="chat-history" id="chatHistoryDisplay">
                <!-- Chat messages will be appended here -->
                <div class="chat-message selfie">Halo! Ada yang bisa Selfie bantu?</div>
            </div>
            <div class="loading-indicator" id="selfieLoadingIndicator" style="display: none;">Selfie sedang berpikir...</div>
            <div class="chat-input-wrapper">
                <input type="text" id="selfieChatInput" placeholder="Ketik pesanmu di sini..." />
                <button id="sendSelfieMessageBtn">Kirim</button>
            </div>
            <div class="modal-actions" style="margin-top: 15px;">
                <button id="closeTalkToSelfieModalBtn" style="background: #444;">Tutup</button>
            </div>
        </div>
    </div>

    <!-- New Custom Modal for Report Confession -->
    <div class="modal-overlay" id="reportModal">
        <div class="modal-content">
            <h3>Laporkan Pengakuan</h3>
            <p>Mengapa Anda ingin melaporkan pengakuan ini?</p>
            <textarea id="reportReasonInput" class="modal-textarea" rows="3" placeholder="Misalnya: Spam, Konten tidak pantas, Lainnya..."></textarea>
            <div class="modal-actions">
                <button id="cancelReport" style="background: #444;">Batal</button>
                <button id="submitReport">Kirim Laporan</button>
            </div>
        </div>
    </div>

    <!-- New Custom Modal for Delete Confirmation -->
    <div class="modal-overlay" id="deleteConfirmModal">
        <div class="modal-content">
            <h3>Hapus Pengakuan?</h3>
            <p>Anda yakin ingin menghapus pengakuan ini? Tindakan ini tidak bisa dibatalkan.</p>
            <div class="modal-actions">
                <button id="cancelDelete" style="background: #444;">Batal</button>
                <button id="confirmDelete" style="background: #dc3545;">Hapus</button>
            </div>
        </div>
    </div>

    <!-- NEW: Comment Modal -->
    <div class="modal-overlay" id="commentModal">
        <div class="modal-content talk-to-selfie-modal-content"> <!-- Reusing talk-to-selfie-modal-content for similar layout -->
            <h3 id="commentModalTitle">Komentar untuk Pengakuan</h3>
            <div class="comments-list-modal" id="currentConfessionComments">
                <!-- Comments for the selected confession will be loaded here -->
            </div>
            <div class="comment-input-wrapper">
                <input type="text" id="modalCommentInput" placeholder="Tulis komentar (max 250 karakter)" maxlength="250">
                <button id="submitModalCommentBtn">Kirim</button>
            </div>
            <div class="comment-char-count" id="modalCommentCharCount">0/250</div>
            <div class="modal-actions" style="margin-top: 15px;">
                <button id="closeCommentModalBtn" style="background: #444;">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, doc, updateDoc, arrayUnion, arrayRemove, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration (DO NOT EDIT)
        // These variables are provided by the Canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // HARDCODED FIREBASE CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyBjaZ6QLUX-LzAPjyPRBHQNYNh1ZkAV_gk",
            authDomain: "selfifyid-4d06c.firebaseapp.com",
            projectId: "selfifyid-4d06c",
            storageBucket: "selfifyid-4d06c.firebasestorage.app",
            messagingSenderId: "583104647123",
            appId: "1:583104647123:web:7abd11dc720165dfa9e926"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        let app;
        let db;
        let auth;

        /**
         * Menampilkan modal error dengan pesan tertentu.
         * Dipindahkan ke atas agar bisa diakses saat inisialisasi Firebase.
         * @param {string} message - Pesan error yang akan ditampilkan.
         */
        function showErrorModal(message) {
            const errorMessageDisplay = document.getElementById('errorMessage');
            const errorModal = document.getElementById('errorModal');
            if (errorMessageDisplay && errorModal) {
                errorMessageDisplay.textContent = message;
                errorModal.classList.add('show');
                document.body.classList.add('modal-open');
            } else {
                console.error("Error modal elements not found. Message:", message);
                alert("Terjadi kesalahan fatal: " + message); // Fallback alert
            }
        }

        try {
            // Periksa apakah firebaseConfig memiliki projectId
            if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.projectId) {
                throw new Error("Konfigurasi Firebase tidak ditemukan atau tidak lengkap. Pastikan lingkungan Canvas menyediakan '__firebase_config'.");
            }
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            console.log("Firebase initialized successfully.");
        } catch (e) {
            console.error("Gagal menginisialisasi Firebase:", e);
            showErrorModal(`Gagal menginisialisasi Firebase: ${e.message}. Beberapa fitur mungkin tidak berfungsi.`);
            // Hentikan eksekusi lebih lanjut jika inisialisasi Firebase gagal
            // Ini mencegah error 'auth is undefined' atau 'db is undefined'
            document.addEventListener('DOMContentLoaded', () => {
                hideGlobalLoading(); // Pastikan loading disembunyikan jika inisialisasi gagal
            });
            throw e; // Lemparkan error agar terlihat di konsol developer
        }

        let userId = null; // Untuk menyimpan ID pengguna yang terautentikasi

        // --- DOM Elements ---
        const confessList = document.getElementById('confessList');
        const loadingMessage = document.getElementById('loadingMessage'); // Ini mungkin tidak lagi digunakan secara langsung karena ada globalLoadingOverlay
        
        const openConfessModalBtn = document.getElementById('openConfessModalBtn');
        const confessModal = document.getElementById('confessModal');
        const successModal = document.getElementById('successModal');
        const errorModal = document.getElementById('errorModal'); // Sudah didefinisikan di atas
        
        const modalConfessText = document.getElementById('modalConfessText');
        const modalConfessCharCount = document.getElementById('modalConfessCharCount'); // New element
        const modalAlterName = document.getElementById('modalAlterName');
        const modalAlterNameCharCount = document.getElementById('modalAlterNameCharCount'); // New element

        const submitConfessBtn = document.getElementById('submitConfess');
        const cancelConfessBtn = document.getElementById('cancelConfess');
        const closeSuccessBtn = document.getElementById('closeSuccessModal');
        const closeErrorBtn = document.getElementById('closeErrorModal'); // Sudah didefinisikan di atas
        // const errorMessageDisplay = document.getElementById('errorMessage'); // Sudah didefinisikan di atas

        const quotesSlider = document.getElementById('quotesSlider');
        const prevQuoteBtn = document.getElementById('prevQuote');
        const nextQuoteBtn = document.getElementById('nextQuote');
        const shareQuoteBtn = document.getElementById('shareQuoteBtn');
        const downloadQuoteBtn = document.getElementById('downloadQuoteBtn');

        const emailInput = document.getElementById('emailInput'); 
        const submitEmailBtn = document.getElementById('submitEmailBtn'); 
        
        // NEW: Talk to Selfie Elements
        const openTalkToSelfieModalBtn = document.getElementById('openTalkToSelfieModalBtn');
        const talkToSelfieModal = document.getElementById('talkToSelfieModal');
        const chatHistoryDisplay = document.getElementById('chatHistoryDisplay');
        const selfieChatInput = document.getElementById('selfieChatInput');
        const sendSelfieMessageBtn = document.getElementById('sendSelfieMessageBtn'); 
        const closeTalkToSelfieModalBtn = document.getElementById('closeTalkToSelfieModalBtn');
        const selfieLoadingIndicator = document.getElementById('selfieLoadingIndicator');

        // NEW: Report Modal Elements
        const reportModal = document.getElementById('reportModal');
        const reportReasonInput = document.getElementById('reportReasonInput');
        const submitReportBtn = document.getElementById('submitReport');
        const cancelReportBtn = document.getElementById('cancelReport');

        // NEW: Delete Modal Elements
        const deleteConfirmModal = document.getElementById('deleteConfirmModal');
        const confirmDeleteBtn = document.getElementById('confirmDelete'); 
        const cancelDeleteBtn = document.getElementById('cancelDelete');
        let confessionIdToDelete = null; // To store the ID of the confession to be deleted

        // NEW: Global Loading Overlay
        const globalLoadingOverlay = document.getElementById('globalLoadingOverlay');
        const globalLoadingMessage = document.getElementById('globalLoadingMessage');

        // NEW: Comment Modal Elements
        const commentModal = document.getElementById('commentModal');
        const commentModalTitle = document.getElementById('commentModalTitle');
        const currentConfessionComments = document.getElementById('currentConfessionComments');
        const modalCommentInput = document.getElementById('modalCommentInput');
        const submitModalCommentBtn = document.getElementById('submitModalCommentBtn');
        const modalCommentCharCount = document.getElementById('modalCommentCharCount');
        const closeCommentModalBtn = document.getElementById('closeCommentModalBtn');
        let currentConfessionIdForComments = null; // To store the ID of the confession whose comments are being viewed

        // Chat history for LLM context
        let chatHistory = [{ role: "model", parts: [{ text: "Halo! Ada yang bisa Selfie bantu?" }] }];

        // --- Quotes Data (Using provided image URLs) ---
        const quotesData = [
            {
                src: "https://i.imghippo.com/files/kmbS3840KWI.png",
                text: "Rehat itu bukan mager, tapi investasi waras."
            },
            {
                src: "https://i.imghippo.com/files/qUo2107OT.png",
                text: "Cukup itu mindset, bukan saldo."
            },
            {
                src: "https://i.imghippo.com/files/SnR8669gcQ.png", 
                text: "Hidup bukan lomba, tiap orang punya pace-nya sendiri."
            },
            {
                src: "https://i.imghippo.com/files/rSS7000wE.png", 
                text: "Vibes positif? Auto-healing."
            },
            {
                src: "https://i.imghippo.com/files/IHED7806DI.png", 
                text: "Bukan semua hal harus dikejar Ada yang cukup lo temukan."
            },
            {
                src: "https://i.imghippo.com/files/DZd8455xyA.png", 
                text: "Kalo burnout itu real, istirahat juga harus total."
            }
        ];

        // --- Functions ---

        /**
         * Menampilkan modal dengan menambahkan kelas 'show' dan mencegah body scrolling.
         * @param {HTMLElement} modalElement - Elemen modal yang akan ditampilkan.
         */
        function showModal(modalElement) {
            console.log('showModal called for:', modalElement.id); // Debugging log
            modalElement.classList.add('show');
            document.body.classList.add('modal-open'); 
        }

        /**
         * Menyembunyikan modal dengan menghapus kelas 'show' dan mengaktifkan kembali body scrolling.
         * @param {HTMLElement} modalElement - Elemen modal yang akan disembunyikan.
         */
        function hideModal(modalElement) {
            console.log('hideModal called for:', modalElement.id); // Debugging log
            modalElement.classList.remove('show');
            document.body.classList.remove('modal-open'); 
        }

        /**
         * Menampilkan pesan toast sementara.
         * @param {string} message - Pesan yang akan ditampilkan.
         */
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast-message';
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('show');
            }, 10); 

            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove(), { once: true });
            }, 2000); 
        }

        /**
         * Menampilkan overlay loading global.
         * @param {string} message - Pesan yang akan ditampilkan di overlay.
         */
        function showGlobalLoading(message = 'Memuat...') {
            globalLoadingMessage.textContent = message;
            globalLoadingOverlay.classList.add('show');
            document.body.classList.add('modal-open'); // Prevent scrolling while global loading is active
        }

        /**
         * Menyembunyikan overlay loading global.
         */
        function hideGlobalLoading() {
            globalLoadingOverlay.classList.remove('show');
            document.body.classList.remove('modal-open'); // Re-enable scrolling
        }

        /**
         * Merender daftar pengakuan ke DOM, termasuk reaksi dan komentar.
         * @param {Array<Object>} confessionsData - Array objek pengakuan.
         */
        function renderConfessions(confessionsData) {
            console.log('renderConfessions called.'); // Debugging log
            // Store the current scroll position
            const currentScrollTop = confessList.scrollTop;
            const isScrolledToBottom = confessList.scrollHeight - confessList.clientHeight <= currentScrollTop + 1; // +1 for tolerance

            confessList.innerHTML = ''; 

            // --- Add dummy confessions for visualization ---
            const dummyConfessions = [
                {
                    id: 'dummy1',
                    text: 'Aku sering merasa tidak cukup baik, meskipun sudah berusaha keras.',
                    alterName: 'ShadowSelf',
                    likes: [], loves: [], fires: [],
                    timestamp: new Date(Date.now() - 3600000) // 1 hour ago
                },
                {
                    id: 'dummy2',
                    text: 'Sulit sekali untuk jujur pada diri sendiri tentang apa yang sebenarnya aku inginkan.',
                    alterName: 'InnerVoice',
                    likes: [], loves: [], fires: [],
                    timestamp: new Date(Date.now() - 7200000) // 2 hours ago
                },
                {
                    id: 'dummy3',
                    text: 'Kadang aku hanya ingin menghilang dari semua tekanan ini.',
                    alterName: 'QuietSoul',
                    likes: [], loves: [], fires: [],
                    timestamp: new Date(Date.now() - 10800000) // 3 hours ago
                }
            ];
            // Combine dummy data with actual fetched data
            const allConfessions = [...dummyConfessions, ...confessionsData];

            // Add posts first, excluding the sticky form
            allConfessions.forEach((confess) => {
                const post = document.createElement('div');
                post.className = 'confess-post';
                post.dataset.id = confess.id; 
                post.innerHTML = `
                    ${confess.text}
                    <div class="actions">
                        <button class="reaction-btn ${((Array.isArray(confess.likes) ? confess.likes : [])).includes(userId) ? 'active' : ''}" data-type="likes" data-id="${confess.id}">
                            ❤️ <span class="count">${confess.likes?.length || 0}</span>
                        </button>
                        <button class="reaction-btn ${((Array.isArray(confess.loves) ? confess.loves : [])).includes(userId) ? 'active' : ''}" data-type="loves" data-id="${confess.id}">
                            💖 <span class="count">${confess.loves?.length || 0}</span>
                        </button>
                        <button class="reaction-btn ${((Array.isArray(confess.fires) ? confess.fires : [])).includes(userId) ? 'active' : ''}" data-type="fires" data-id="${confess.id}">
                            🔥 <span class="count">${confess.fires?.length || 0}</span>
                        </button>
                        <button class="comment-icon-btn" data-id="${confess.id}" style="padding: 4px 8px; font-size: 12px;">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H16.5m3.75 0a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM12 18.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5ZM12 12.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5ZM12 6.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 0 1-2.25 2.25h-15a2.25 2.25 0 0 1-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0 0 19.5 4.5h-15A2.25 2.25 0 0 0 2.25 6.75m19.5 0v.243a2.25 2.25 0 0 1-1.07 1.972l-7.5 4.288M1.5 6.75v.243a2.25 2.25 0 0 0 1.07 1.972l7.5 4.288m1.5 3.5V12a.75.75 0 0 0-.75-.75H10.5a.75.75 0 0 0-.75.75v1.5m1.5 0H12" />
                            </svg>
                            Comment
                        </button>
                        <button class="share-confession-btn" data-id="${confess.id}" style="padding: 4px 8px;">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M7.217 10.907a2.25 2.25 0 1 0 0 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186 9.566-5.314m-9.566 7.5 9.566 5.314m0 0a2.25 2.25 0 1 0 3.935 2.186 2.25 2.25 0 0 0-3.935-2.186Zm0-12.814a2.25 2.25 0 1 0 3.933-2.186 2.25 2.25 0 0 0-3.933 2.186Z" />
                            </svg>
                        </button>
                        ${confess.userId === userId ? `
                        <button class="delete-confession-btn" data-id="${confess.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.927a2.25 2.25 0 0 1-2.244-2.077L5.072 5.455m14.088 0a2.25 2.25 0 0 0-2.244-2.077H8.927a2.25 2.25 0 0 0-2.244 2.077M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                            </svg>
                            Hapus
                        </button>
                        ` : ''}
                    </div>
                `;
                confessList.appendChild(post);

                // Setup event listeners for reaction buttons
                post.querySelectorAll('.reaction-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const confessionId = e.currentTarget.dataset.id;
                        const reactionType = e.currentTarget.dataset.type;
                        toggleReaction(confessionId, reactionType);
                    });
                });

                // Setup event listener for comment button
                const commentButton = post.querySelector(`.comment-icon-btn`);
                if (commentButton) {
                    commentButton.addEventListener('click', (e) => {
                        const confessionId = e.currentTarget.dataset.id;
                        showCommentModal(confessionId);
                    });
                }

                if (!confess.id.startsWith('dummy')) {
                    // Setup event listener for share button for real confessions
                    const shareButton = post.querySelector(`.share-confession-btn`);
                    if (shareButton) {
                        shareButton.addEventListener('click', () => {
                            shareConfession(confess.text); // Pass the text directly
                        });
                    }
                    const deleteButton = post.querySelector(`.delete-confession-btn`);
                    if (deleteButton) { // This button only exists if userId matches
                        deleteButton.addEventListener('click', (e) => {
                            confessionIdToDelete = e.currentTarget.dataset.id;
                            showModal(deleteConfirmModal);
                        });
                    }
                } else {
                    // Disable share, comment, and delete buttons for dummy posts
                    const shareButton = post.querySelector(`.share-confession-btn`);
                    if (shareButton) {
                        shareButton.disabled = true;
                        shareButton.style.opacity = '0.5';
                        shareButton.style.cursor = 'not-allowed';
                    }
                    if (commentButton) {
                        commentButton.disabled = true;
                        commentButton.style.opacity = '0.5';
                        commentButton.style.cursor = 'not-allowed';
                    }
                    const deleteButton = post.querySelector(`.delete-confession-btn`);
                    if (deleteButton) {
                        deleteButton.disabled = true;
                        deleteButton.style.opacity = '0.5';
                        deleteButton.style.cursor = 'not-allowed';
                    }
                }
            });

            // Add the sticky form after all posts
            const stickyFormHtml = `
                <div class="confess-form">
                    <button id="openConfessModalBtn">Curhat? Confess? Boleh banget.</button>
                </div>
            `;
            confessList.insertAdjacentHTML('beforeend', stickyFormHtml);

            // Re-attach event listener for the sticky button
            const newOpenConfessModalBtn = confessList.querySelector('#openConfessModalBtn');
            if (newOpenConfessModalBtn) {
                console.log('openConfessModalBtn found and listener re-attached.'); // Debugging log
                newOpenConfessModalBtn.addEventListener('click', () => {
                    console.log('openConfessModalBtn clicked!'); // Debugging log
                    showModal(confessModal);
                });
            } else {
                console.error('openConfessModalBtn not found after rendering confessions.'); // Debugging log
            }


            if (allConfessions.length === 0) { // Check against allConfessions, including dummies
                confessList.innerHTML = '<div style="color: var(--secondary-text-color); padding: 20px;">Belum ada pengakuan. Jadilah yang pertama!</div>' + stickyFormHtml;
            }

            // Restore scroll position or scroll to bottom if it was already there
            if (isScrolledToBottom) {
                confessList.scrollTop = confessList.scrollHeight;
            } else {
                confessList.scrollTop = currentScrollTop;
            }
        }

        /**
         * Mengelola penambahan atau penghapusan reaksi (like, love, fire) pada pengakuan.
         * @param {string} confessionId - ID dokumen pengakuan.
         * @param {string} reactionType - Tipe reaksi ('likes', 'loves', 'fires').
         */
        async function toggleReaction(confessionId, reactionType) {
            if (!userId) {
                showErrorModal('Anda perlu login untuk memberikan reaksi.');
                return;
            }
            if (confessionId.startsWith('dummy')) {
                showToast('Tidak bisa bereaksi pada pengakuan dummy.');
                return;
            }

            const confessionRef = doc(db, `artifacts/${appId}/public/data/confessions`, confessionId);
            try {
                const docSnap = await getDoc(confessionRef);
                if (docSnap.exists()) {
                    const currentReactions = docSnap.data()[reactionType] || [];
                    if (currentReactions.includes(userId)) {
                        // Jika sudah ada, hapus reaksi
                        await updateDoc(confessionRef, {
                            [reactionType]: arrayRemove(userId)
                        });
                    } else {
                        // Jika belum ada, tambahkan reaksi
                        // Pertama, hapus reaksi lain dari pengguna ini untuk memastikan hanya 1 opsi
                        const allReactionTypes = ['likes', 'loves', 'fires'];
                        for (const type of allReactionTypes) {
                            if (type !== reactionType) {
                                const otherReactions = docSnap.data()[type] || [];
                                if (otherReactions.includes(userId)) {
                                    await updateDoc(confessionRef, {
                                        [type]: arrayRemove(userId)
                                    });
                                }
                            }
                        }
                        // Kemudian, tambahkan reaksi yang dipilih
                        await updateDoc(confessionRef, {
                            [reactionType]: arrayUnion(userId)
                        });
                    }
                }
            } catch (error) {
                console.error(`Error toggling ${reactionType}:`, error);
                showErrorModal(`Gagal memberikan reaksi. Silakan coba lagi.`);
            }
        }

        /**
         * Menampilkan modal komentar dan memuat komentar untuk pengakuan tertentu.
         * @param {string} confessionId - ID dokumen pengakuan yang komentarnya akan ditampilkan.
         */
        function showCommentModal(confessionId) {
            if (!userId) {
                showErrorModal('Anda perlu login untuk melihat atau mengirim komentar.');
                return;
            }
            if (confessionId.startsWith('dummy')) {
                showToast('Tidak bisa melihat komentar pada pengakuan dummy.');
                return;
            }

            currentConfessionIdForComments = confessionId;
            commentModalTitle.textContent = `Comment for Confession ID: ${confessionId.substring(0, 5)}...`; // Show truncated ID
            modalCommentInput.value = ''; // Clear comment input
            modalCommentCharCount.textContent = `0/250`; // Reset char count
            modalCommentCharCount.classList.remove('warning'); // Remove warning

            // Clear previous comments and show loading message
            currentConfessionComments.innerHTML = '<div style="color: var(--secondary-text-color); font-size: 12px; text-align: center; padding: 10px;">Memuat komentar...</div>';

            // Set up real-time listener for comments of this specific confession
            setupCommentsListener(confessionId);
            showModal(commentModal);
        }

        /**
         * Merender daftar komentar ke DOM dalam modal komentar.
         * @param {Array<Object>} commentsData - Array objek komentar.
         */
        function renderCommentsInModal(commentsData) {
            if (!currentConfessionComments) return;

            currentConfessionComments.innerHTML = ''; 
            if (commentsData.length === 0) {
                currentConfessionComments.innerHTML = '<div style="color: var(--secondary-text-color); font-size: 12px; text-align: center; padding: 10px;">Belum ada komentar. Jadilah yang pertama!</div>';
                return;
            }

            commentsData.forEach(comment => {
                const commentItem = document.createElement('div');
                commentItem.className = 'comment-item';
                commentItem.innerHTML = `<strong>${comment.alterName || 'Anonim'}:</strong> ${comment.text}`;
                currentConfessionComments.appendChild(commentItem);
            });
            currentConfessionComments.scrollTop = currentConfessionComments.scrollHeight; 
        }

        /**
         * Menyiapkan listener real-time untuk komentar pada pengakuan tertentu.
         * @param {string} confessionId - ID dokumen pengakuan.
         */
        function setupCommentsListener(confessionId) {
            const commentsCollectionRef = collection(db, `artifacts/${appId}/public/data/confessions/${confessionId}/comments`);
            const q = query(commentsCollectionRef); 

            // Detach previous listener if any
            if (typeof currentCommentsUnsubscribe === 'function') {
                currentCommentsUnsubscribe();
            }

            // Attach new listener
            currentCommentsUnsubscribe = onSnapshot(q, (snapshot) => {
                const fetchedComments = [];
                snapshot.forEach((doc) => {
                    fetchedComments.push({ id: doc.id, ...doc.data() });
                });
                fetchedComments.sort((a, b) => (a.timestamp?.toDate() || 0) - (b.timestamp?.toDate() || 0));
                renderCommentsInModal(fetchedComments); // Render to modal
            }, (error) => {
                console.error(`Error fetching comments for ${confessionId}:`, error);
                if (currentConfessionComments) {
                    currentConfessionComments.innerHTML = '<div style="color: red; font-size: 12px; text-align: center; padding: 10px;">Gagal memuat komentar.</div>';
                }
            });
        }
        let currentCommentsUnsubscribe = null; // To store the unsubscribe function for comments listener


        /**
         * Mengirimkan komentar baru ke Firestore.
         * Menggunakan currentConfessionIdForComments untuk mengetahui pengakuan mana yang sedang dikomentari.
         */
        async function submitCommentToModal() {
            if (!userId) {
                showErrorModal('Anda perlu login untuk mengirim komentar.');
                return;
            }
            if (!currentConfessionIdForComments) {
                showErrorModal('Tidak ada pengakuan yang dipilih untuk dikomentari.');
                return;
            }

            const commentText = modalCommentInput.value.trim();
            const COMMENT_MAX_LENGTH = 250;

            if (commentText.length === 0) {
                modalCommentInput.style.borderColor = 'red';
                setTimeout(() => { modalCommentInput.style.borderColor = 'var(--border-color)'; }, 1500);
                return;
            }
            if (commentText.length > COMMENT_MAX_LENGTH) {
                showErrorModal(`Komentar terlalu panjang. Maksimal ${COMMENT_MAX_LENGTH} karakter.`);
                return;
            }

            submitModalCommentBtn.textContent = 'Mengirim...';
            submitModalCommentBtn.disabled = true;

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/confessions/${currentConfessionIdForComments}/comments`), {
                    text: commentText,
                    alterName: "Anonim", 
                    timestamp: serverTimestamp(),
                    userId: userId
                });
                modalCommentInput.value = ''; 
                showToast('Komentar terkirim!');
            } catch (error) {
                console.error("Error adding comment: ", error);
                showErrorModal('Terjadi kesalahan saat mengirim komentar. Silakan coba lagi.');
            } finally {
                submitModalCommentBtn.textContent = 'Kirim';
                submitModalCommentBtn.disabled = false;
            }
        }


        /**
         * Menyiapkan listener real-time untuk pengakuan dari Firestore.
         */
        function setupConfessionsListener() {
            if (!db) {
                console.error("Firestore is not initialized. Cannot set up confessions listener.");
                hideGlobalLoading(); // Ensure loading is hidden if DB is not ready
                return;
            }
            
            // Define the collection path for public data
            const confessionsCollectionRef = collection(db, `artifacts/${appId}/public/data/confessions`);
            
            // Create a query to order confessions by creation date (newest first)
            const q = query(confessionsCollectionRef); 

            // Show global loading when starting to fetch confessions
            showGlobalLoading('Memuat pengakuan...');

            // Set up a real-time listener
            onSnapshot(q, (snapshot) => {
                const fetchedConfessions = [];
                snapshot.forEach((doc) => {
                    fetchedConfessions.push({ id: doc.id, ...doc.data() }); // Include doc.id
                });
                // Sort by timestamp in descending order (newest first) in memory
                fetchedConfessions.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
                renderConfessions(fetchedConfessions);
                hideGlobalLoading(); // Hide loading message once data is rendered
            }, (error) => {
                console.error("Error fetching confessions: ", error);
                hideGlobalLoading(); // Hide loading even on error
                showErrorModal('Gagal memuat pengakuan. Silakan coba refresh halaman.');
            });
        }

        /**
         * Menangani pengiriman pengakuan baru ke Firestore.
         */
        async function submitConfession() {
            const text = modalConfessText.value.trim();
            const alter = modalAlterName.value.trim();

            let isValid = true;
            
            // Basic validation: check if text and alterName are not empty
            if (text.length === 0) {
                modalConfessText.style.borderColor = 'red';
                setTimeout(() => { modalConfessText.style.borderColor = 'var(--border-color)'; }, 1500);
                isValid = false;
            } else if (text.length > CONFESS_MAX_LENGTH) { // New validation for max length
                showErrorModal(`Pengakuan terlalu panjang. Maksimal ${CONFESS_MAX_LENGTH} karakter.`);
                isValid = false;
            }
            
            if (alter.length === 0) {
                modalAlterName.parentElement.style.borderColor = 'red';
                setTimeout(() => { modalAlterName.parentElement.style.borderColor = 'var(--border-color)'; }, 1500);
                isValid = false;
            } else if (alter.length > ALTER_NAME_MAX_LENGTH) { // New validation for alter name length
                showErrorModal(`Nama alter terlalu panjang. Maksimal ${ALTER_NAME_MAX_LENGTH} karakter.`);
                isValid = false;
            }

            if (!isValid) return; // Stop if validation fails

            submitConfessBtn.textContent = 'Mengirim...';
            submitConfessBtn.disabled = true;
            
            try {
                // Ensure user is authenticated before adding data
                if (!userId) {
                    console.error("User not authenticated. Cannot submit confession.");
                    showErrorModal('Anda perlu login untuk mengirim pengakuan.');
                    return;
                }

                // Add a new document to the 'confessions' collection
                await addDoc(collection(db, `artifacts/${appId}/public/data/confessions`), {
                    text: text,
                    alterName: alter,
                    likes: [], // Initialize as empty array for user IDs
                    loves: [], // Initialize as empty array for user IDs
                    fires: [], // Initialize as empty array for user IDs
                    timestamp: serverTimestamp(), // Use server timestamp for consistent ordering
                    userId: userId // Store the user ID who made the confession
                });
                
                // Reset input fields
                modalConfessText.value = '';
                modalAlterName.value = '';
                
                // Hide confession modal and show success modal
                hideModal(confessModal);
                showModal(successModal);

            } catch (e) {
                console.error("Error adding document: ", e);
                showErrorModal('Terjadi kesalahan saat mengirim pengakuan. Silakan coba lagi.');
            } finally {
                submitConfessBtn.textContent = 'Kirim';
                submitConfessBtn.disabled = false;
            }
        }

        /**
         * Menangani pengiriman email (placeholder untuk Netlify Function).
         */
        async function submitEmail() {
            const email = emailInput.value.trim();
            if (!email) {
                emailInput.style.borderColor = 'red';
                setTimeout(() => { emailInput.style.borderColor = 'var(--border-color)'; }, 1500);
                showErrorModal('Email tidak boleh kosong.');
                return;
            }

            // --- Placeholder untuk pemanggilan Netlify Function ---
            // Nanti di sini akan ada kode untuk memanggil Netlify Function
            // yang akan mengirim email notifikasi ke admin.
            // Contoh:
            /*
            try {
                const response = await fetch('/.netlify/functions/notify-admin-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email, userId: userId })
                });
                if (!response.ok) {
                    throw new Error('Gagal mengirim notifikasi email.');
                }
                showToast('Email Anda telah terdaftar!');
                emailInput.value = ''; // Kosongkan input setelah sukses
            } catch (error) {
                console.error("Error submitting email:", error);
                showErrorModal('Gagal mendaftarkan email Anda. Silakan coba lagi.');
            }
            */
            // Untuk saat ini, kita akan langsung mengosongkan input dan menampilkan pesan sukses
            showToast('Email Anda telah terdaftar! (Notifikasi admin akan aktif setelah Netlify Function dikonfigurasi)');
            emailInput.value = ''; // Kosongkan input setelah sukses
        }

        /**
         * Mengunduh gambar quote yang sedang terlihat.
         * Catatan: Mengunduh gambar dari domain lain (cross-origin) secara langsung melalui JavaScript
         * bisa jadi rumit karena batasan keamanan browser (CORS).
         * Untuk placeholder placehold.co, mungkin tidak mengizinkan unduhan langsung.
         * Pengguna mungkin perlu mengklik kanan dan menyimpan gambar secara manual.
         */
        function downloadCurrentQuote() {
            showToast('Untuk mengunduh gambar, silakan klik kanan pada gambar dan pilih "Simpan Gambar Sebagai..."');
            // Atau, jika Anda memiliki kontrol atas server gambar dan CORS diizinkan:
            // const slideWidth = quotesSlider.querySelector('.quote-slide').clientWidth;
            // const currentIndex = Math.round(quotesSlider.scrollLeft / slideWidth);
            // const currentImageSrc = quotesData[currentIndex].src;

            // fetch(currentImageSrc)
            //     .then(response => response.blob())
            //     .then(blob => {
            //         const url = URL.createObjectURL(blob);
            //         const a = document.createElement('a');
            //         a.href = url;
            //         a.download = `selfify_quote_${currentIndex + 1}.png`; // Sesuaikan ekstensi jika bukan png
            //         document.body.appendChild(a);
            //         a.click();
            //         document.body.removeChild(a);
            //         URL.revokeObjectURL(url);
            //         showToast('Gambar diunduh!');
            //     })
            //     .catch(error => {
            //         console.error('Error downloading image:', error);
            //         showErrorModal('Gagal mengunduh gambar. Pastikan gambar dapat diakses atau coba cara manual.');
            //     });
        }

        /**
         * Menyalin teks quote atau membagikan menggunakan Web Share API.
         */
        async function shareCurrentQuote() {
            const slideWidth = quotesSlider.querySelector('.quote-slide').clientWidth;
            const currentIndex = Math.round(quotesSlider.scrollLeft / slideWidth);
            const currentQuoteText = quotesData[currentIndex].text; // Ambil teks dari array data

            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Manifesto Selfify',
                        text: currentQuoteText,
                        url: window.location.href 
                    });
                    showToast('Quote berhasil dibagikan!');
                } catch (error) {
                    console.error('Error sharing:', error);
                    // Fallback to copy if Web Share API fails or not supported
                    copyTextToClipboard(currentQuoteText);
                    showToast('Teks quote disalin!');
                }
            } else {
                copyTextToClipboard(currentQuoteText);
                showToast('Teks quote disalin!');
            }
        }

        /**
         * Fungsi pembantu untuk menyalin teks ke clipboard.
         * @param {string} text - Teks yang akan disalin.
         */
        function copyTextToClipboard(text) {
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = text;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            document.execCommand('copy'); // Deprecated but widely supported in iframes
            document.body.removeChild(tempTextArea);
        }

        /**
         * Mengatur tampilan awal slider quotes dan memuat gambar.
         */
        async function setupQuotesSlider() {
            if (!quotesSlider) {
                console.error("quotesSlider element not found!");
                return;
            }

            quotesSlider.innerHTML = ''; // Clear existing content
            // No global loading here, as images are loaded directly by browser from 'uploaded:' path

            quotesData.forEach((quote, index) => {
                const slide = document.createElement('div');
                slide.className = 'quote-slide';
                const img = document.createElement('img');
                img.src = quote.src; // Directly use the 'uploaded:' path or Base64
                img.alt = quote.text; // Alt text for accessibility
                img.onload = () => console.log(`Quote image ${index + 1} loaded successfully: ${quote.src}`);
                img.onerror = function() { 
                    console.error(`Failed to load quote image ${index + 1}: ${this.src}. Using fallback.`);
                    this.onerror=null;
                    this.src="https://placehold.co/300x300/cccccc/000000?text=Gambar+Rusak";
                    this.alt="Gambar quote tidak dapat dimuat.";
                };
                slide.appendChild(img);
                quotesSlider.appendChild(slide);
            });

            quotesSlider.scrollLeft = 0; 
            // No hideGlobalLoading here, as it's not shown specifically for quotes loading anymore.
        }


        /**
         * Mengirim pesan ke model bahasa besar (LLM) dan menampilkan responsnya.
         * Menggunakan exponential backoff untuk retry.
         * @param {string} userMessage - Pesan dari pengguna.
         */
        async function sendMessageToSelfie(userMessage) {
            if (!userMessage.trim()) return;

            // Add user message to chat history display
            const userMsgElement = document.createElement('div');
            userMsgElement.className = 'chat-message user';
            userMsgElement.textContent = userMessage;
            chatHistoryDisplay.appendChild(userMsgElement);
            chatHistoryDisplay.scrollTop = chatHistoryDisplay.scrollHeight; // Scroll to bottom

            // Add user message to chat history for LLM context
            chatHistory.push({ role: "user", parts: [{ text: userMessage }] });

            selfieChatInput.value = ''; // Clear input
            sendSelfieMessageBtn.disabled = true; // Disable send button
            selfieLoadingIndicator.style.display = 'block'; // Show loading indicator

            const MAX_RETRIES = 5;
            let retryCount = 0;
            let success = false;

            while (retryCount < MAX_RETRIES && !success) {
                try {
                    const payload = { contents: chatHistory };
                    const apiKey = ""; // If you want to use models other than gemini-2.5-flash-preview-05-20 or imagen-3.0-generate-002, provide an API key here. Otherwise, leave this as-is.
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && retryCount < MAX_RETRIES - 1) { // Too Many Requests
                            const delay = Math.pow(2, retryCount) * 1000; // Exponential backoff
                            console.warn(`Rate limit hit. Retrying in ${delay / 1000}s...`);
                            await new Promise(res => setTimeout(res, delay));
                            retryCount++;
                            continue; // Retry the loop
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const selfieResponseText = result.candidates[0].content.parts[0].text;
                        
                        // Add Selfie's response to chat history display
                        const selfieMsgElement = document.createElement('div');
                        selfieMsgElement.className = 'chat-message selfie';
                        selfieMsgElement.textContent = selfieResponseText;
                        chatHistoryDisplay.appendChild(selfieMsgElement);
                        chatHistoryDisplay.scrollTop = chatHistoryDisplay.scrollHeight; // Scroll to bottom

                        // Add Selfie's response to chat history for LLM context
                        chatHistory.push({ role: "model", parts: [{ text: selfieResponseText }] });
                        success = true; // Mark as success
                    } else {
                        throw new Error("Unexpected API response structure or missing content.");
                    }
                } catch (error) {
                    console.error("Error talking to Selfie:", error);
                    const errorMsgElement = document.createElement('div');
                    errorMsgElement.className = 'chat-message selfie';
                    errorMsgElement.textContent = "Maaf, Selfie sedang tidak bisa merespons. Coba lagi nanti.";
                    chatHistoryDisplay.appendChild(errorMsgElement);
                    chatHistoryDisplay.scrollTop = chatHistoryDisplay.scrollHeight;
                    break; // Exit loop on critical error
                } finally {
                    selfieLoadingIndicator.style.display = 'none'; // Hide loading indicator
                    sendSelfieMessageBtn.disabled = false; // Re-enable send button
                }
            }
        }

        /**
         * Menampilkan modal pelaporan pengakuan.
         * @param {string} confessionId - ID pengakuan yang akan dilaporkan.
         * @param {string} confessionText - Teks pengakuan yang akan dilaporkan.
         */
        let currentConfessionToReport = null; // Store the confession ID temporarily
        let currentConfessionTextToReport = null; // Store the confession text temporarily

        function showReportModal(confessionId, confessionText) {
            if (!userId) {
                showErrorModal('Anda perlu login untuk melaporkan pengakuan.');
                return;
            }
            currentConfessionToReport = confessionId;
            currentConfessionTextToReport = confessionText;
            reportReasonInput.value = ''; // Clear previous input
            showModal(reportModal);
        }

        /**
         * Mengirim laporan pengakuan ke Firestore.
         */
        async function submitReport() {
            const reason = reportReasonInput.value.trim();
            if (reason.length === 0) {
                reportReasonInput.style.borderColor = 'red';
                setTimeout(() => { reportReasonInput.style.borderColor = 'var(--border-color)'; }, 1500);
                return;
            }

            submitReportBtn.textContent = 'Mengirim Laporan...';
            submitReportBtn.disabled = true;

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/reports`), {
                    reporterUserId: userId,
                    confessionId: currentConfessionToReport,
                    confessionText: currentConfessionTextToReport,
                    reason: reason,
                    timestamp: serverTimestamp()
                });
                hideModal(reportModal);
                showToast('Laporan Anda telah terkirim. Terima kasih!');
            } catch (error) {
                console.error("Error submitting report:", error);
                showErrorModal('Gagal mengirim laporan. Silakan coba lagi.');
            } finally {
                currentConfessionToReport = null;
                currentConfessionTextToReport = null;
                submitReportBtn.textContent = 'Kirim Laporan';
                submitReportBtn.disabled = false;
            }
        }

        /**
         * Menghapus pengakuan dari Firestore.
         */
        async function performDeleteConfession() {
            if (!confessionIdToDelete) {
                console.error("No confession ID to delete.");
                showErrorModal('Tidak ada pengakuan yang dipilih untuk dihapus.');
                return;
            }

            hideModal(deleteConfirmModal); // Hide confirmation modal immediately

            confirmDeleteBtn.textContent = 'Menghapus...';
            confirmDeleteBtn.disabled = true;
            cancelDeleteBtn.disabled = true;

            try {
                const confessionRef = doc(db, `artifacts/${appId}/public/data/confessions`, confessionIdToDelete);
                await deleteDoc(confessionRef);
                showToast('Pengakuan berhasil dihapus!');
            } catch (error) {
                console.error("Error deleting confession:", error);
                showErrorModal('Gagal menghapus pengakuan. Silakan coba lagi.');
            } finally {
                confessionIdToDelete = null; // Reset the stored ID
                confirmDeleteBtn.textContent = 'Hapus';
                confirmDeleteBtn.disabled = false;
                cancelDeleteBtn.disabled = false;
            }
        }

        /**
         * Menyalin teks pengakuan ke clipboard atau membagikan menggunakan Web Share API.
         * @param {string} confessionText - Teks pengakuan yang akan dibagikan.
         */
        async function shareConfession(confessionText) {
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Manifesto Selfify - Pengakuan',
                        text: `Pengakuan dari Manifesto Selfify: "${confessionText}"`,
                        url: window.location.href 
                    });
                    showToast('Pengakuan berhasil dibagikan!');
                } catch (error) {
                    console.error('Error sharing confession:', error);
                    copyTextToClipboard(confessionText);
                    showToast('Teks pengakuan disalin!');
                }
            } else {
                copyTextToClipboard(confessionText);
                showToast('Teks pengakuan disalin!');
            }
        }


        // --- Event Listeners ---
        // Event listener untuk membuka modal pengakuan
        //openConfessModalBtn.addEventListener('click', () => { // This listener is now attached dynamically in renderConfessions
        //    showModal(confessModal);
        //});

        // Event listener untuk mengirim pengakuan baru
        submitConfessBtn.addEventListener('click', submitConfession);
        
        // Event listener untuk membatalkan pengakuan baru
        cancelConfessBtn.addEventListener('click', () => {
            hideModal(confessModal);
            modalConfessText.value = ''; // Clear textarea
            modalAlterName.value = ''; // Clear input
            modalConfessCharCount.textContent = `0/${CONFESS_MAX_LENGTH}`; // Reset char count
            modalConfessCharCount.classList.remove('warning'); // Remove warning
            modalAlterNameCharCount.textContent = `0/${ALTER_NAME_MAX_LENGTH}`; // Reset alter name char count
            modalAlterNameCharCount.classList.remove('warning'); // Remove alter name warning
        });

        // Event listener untuk menutup modal pesan sukses
        closeSuccessBtn.addEventListener('click', () => {
            hideModal(successModal);
        });

        // Event listener untuk menutup modal pesan error
        closeErrorBtn.addEventListener('click', () => {
            hideModal(errorModal);
        });

        // Event listener untuk navigasi ke quote sebelumnya
        prevQuoteBtn.addEventListener('click', () => {
            quotesSlider.scrollBy({ left: -quotesSlider.clientWidth, behavior: 'smooth' });
        });

        // Event listener untuk navigasi ke quote berikutnya
        nextQuoteBtn.addEventListener('click', () => {
            quotesSlider.scrollBy({ left: quotesSlider.clientWidth, behavior: 'smooth' });
        });

        // Event listener untuk mengunduh quote
        downloadQuoteBtn.addEventListener('click', downloadCurrentQuote);

        // Event listener untuk membagikan quote
        shareQuoteBtn.addEventListener('click', shareCurrentQuote);

        // Event listener untuk submit email
        submitEmailBtn.addEventListener('click', submitEmail);

        // Tutup modal dengan mengklik overlay
        window.addEventListener('click', (e) => {
            if (e.target === confessModal) hideModal(confessModal);
            if (e.target === successModal) hideModal(successModal);
            if (e.target === errorModal) hideModal(errorModal); 
            if (e.target === talkToSelfieModal) hideModal(talkToSelfieModal); 
            if (e.target === reportModal) hideModal(reportModal); 
            if (e.target === deleteConfirmModal) hideModal(deleteConfirmModal); 
            if (e.target === commentModal) hideModal(commentModal); // NEW: Close comment modal
        });

        // Talk to Selfie Event Listeners
        openTalkToSelfieModalBtn.addEventListener('click', () => {
            showModal(talkToSelfieModal);
            selfieChatInput.focus(); // Focus on input when modal opens
            chatHistoryDisplay.scrollTop = chatHistoryDisplay.scrollHeight; // Scroll to bottom
        });

        closeTalkToSelfieModalBtn.addEventListener('click', () => {
            hideModal(talkToSelfieModal);
        });

        sendSelfieMessageBtn.addEventListener('click', () => {
            sendMessageToSelfie(selfieChatInput.value);
        });

        selfieChatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessageToSelfie(selfieChatInput.value);
            }
        });

        // NEW: Event listener for confession text area character count
        const CONFESS_MAX_LENGTH = 500; // Max length for confession text
        modalConfessText.addEventListener('input', () => {
            const currentLength = modalConfessText.value.length;
            modalConfessCharCount.textContent = `${currentLength}/${CONFESS_MAX_LENGTH}`;
            if (currentLength >= CONFESS_MAX_LENGTH - 50) { // Warning 50 chars before limit
                modalConfessCharCount.classList.add('warning');
            } else {
                modalConfessCharCount.classList.remove('warning');
            }
        });

        // NEW: Event listener for alter name input character count
        const ALTER_NAME_MAX_LENGTH = 20; // Max length for alter name
        modalAlterName.addEventListener('input', () => {
            const currentLength = modalAlterName.value.length;
            modalAlterNameCharCount.textContent = `${currentLength}/${ALTER_NAME_MAX_LENGTH}`;
            if (currentLength >= ALTER_NAME_MAX_LENGTH - 5) { // Warning 5 chars before limit
                modalAlterNameCharCount.classList.add('warning');
            } else {
                modalAlterNameCharCount.classList.remove('warning');
            }
        });

        // NEW: Report Modal Event Listeners
        submitReportBtn.addEventListener('click', submitReport);
        cancelReportBtn.addEventListener('click', () => {
            hideModal(reportModal);
            reportReasonInput.value = ''; // Clear input
        });

        // NEW: Delete Modal Event Listeners
        confirmDeleteBtn.addEventListener('click', performDeleteConfession);
        cancelDeleteBtn.addEventListener('click', () => {
            hideModal(deleteConfirmModal);
            confessionIdToDelete = null; // Clear stored ID
        });

        // NEW: Comment Modal Event Listeners
        submitModalCommentBtn.addEventListener('click', submitCommentToModal);
        closeCommentModalBtn.addEventListener('click', () => {
            hideModal(commentModal);
            currentConfessionIdForComments = null; // Clear the ID when modal is closed
            if (typeof currentCommentsUnsubscribe === 'function') {
                currentCommentsUnsubscribe(); // Detach the listener
            }
        });
        modalCommentInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                submitCommentToModal();
            }
        });
        modalCommentInput.addEventListener('input', () => {
            const currentLength = modalCommentInput.value.length;
            modalCommentCharCount.textContent = `${currentLength}/250`;
            if (currentLength >= 240) { 
                modalCommentCharCount.classList.add('warning');
            } else {
                modalCommentCharCount.classList.remove('warning');
            }
        });


        // --- Initial Load ---
        // Authenticate user and then set up Firestore listener
        // Ini hanya akan dijalankan jika inisialisasi Firebase berhasil
        if (auth) { // Pastikan 'auth' terdefinisi sebelum mencoba menggunakannya
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("Authenticated with Firebase. User ID:", userId);
                    setupConfessionsListener(); // Start listening for confessions once authenticated
                } else {
                    // Jika tidak ada pengguna yang login, coba masuk secara anonim
                    try {
                        await signInAnonymously(auth);
                        // Jika ada initialAuthToken, ini dapat digunakan untuk tujuan spesifik Canvas,
                        // tetapi untuk fungsionalitas aplikasi ini, autentikasi anonim sudah cukup.
                    } catch (error) {
                        console.error("Error during anonymous sign-in:", error);
                        showErrorModal('Gagal melakukan autentikasi. Beberapa fitur mungkin tidak berfungsi.');
                        hideGlobalLoading(); // Pastikan loading disembunyikan jika ada error autentikasi
                    }
                }
                // Always setup quotes slider after auth state is determined,
                // as it might use global loading which depends on body.modal-open state.
                setupQuotesSlider();
            });
        } else {
            console.error("Firebase Auth not initialized. Skipping authentication listener.");
            // Jika auth tidak terinisialisasi, pastikan loading disembunyikan
            document.addEventListener('DOMContentLoaded', () => {
                hideGlobalLoading();
                setupQuotesSlider(); // Still try to load quotes if auth is not ready
            });
        }

        // Ensure the initial render of the slider is correct on DOMContentLoaded
        // This is now handled within the onAuthStateChanged callback to ensure correct loading state.
        // document.addEventListener('DOMContentLoaded', () => {
        //     setupQuotesSlider();
        // });

    </script>
</body>
</html>
