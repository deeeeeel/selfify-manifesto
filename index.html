<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Manifesto - Confess Wall</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Lexend:wght@700&display=swap" rel="stylesheet">
    <style>
        /* CSS Variables for easy theme management */
        :root {
            --background-color: #121212;
            --surface-color: #1e1e1e;
            --primary-color: #fde047; /* Brighter Yellow */
            --primary-text-color: #e5e5e5;
            --secondary-text-color: #a3a3a3;
            --card-background: #2a2a2a;
            --border-color: #404040;
            --font-main: 'Inter', sans-serif;
            --font-heading: 'Lexend', sans-serif;
        }

        /* Custom Scrollbar for the main page */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--surface-color);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #ffc107;
        }

        body {
            background: var(--background-color);
            color: var(--primary-text-color);
            font-family: var(--font-main);
            margin: 0;
            padding: 40px 16px;
            text-align: center;
            display: flex;
            flex-direction: column; /* Changed to column to stack content */
            justify-content: flex-start; /* Align content to the top */
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
            overflow-y: auto; /* Allow body to scroll if content exceeds viewport */
        }

        /* CSS to prevent body scrolling when a modal is open */
        body.modal-open {
            overflow: hidden;
        }

        .container {
            max-width: 400px;
            width: 100%;
            margin: 0 auto;
        }

        h2 {
            font-family: var(--font-heading);
            font-size: 28px;
            /* Updated color to grey and added a subtle yellow glow */
            color: var(--card-background); /* Grey color similar to card background */
            text-shadow: 0 0 8px rgba(253, 224, 71, 0.6), /* Yellow glow */
                         0 0 15px rgba(253, 224, 71, 0.3); /* Fainter glow for depth */
            margin-bottom: 16px;
        }

        .poem {
            /* REVISED STYLING FOR "TEGAS" */
            font-style: normal; /* Removed italic */
            color: var(--secondary-text-color);
            line-height: 1.6; /* Adjusted line height for readability */
            margin-bottom: 32px;
            font-size: 16px; /* Slightly larger font size */
            font-weight: bold; /* Made the font bold */
            white-space: pre-line; /* Preserves line breaks from HTML */
            padding: 0 8px; /* Added slight horizontal padding to prevent text from touching edges */
        }

        .question {
            font-size: 18px;
            font-weight: bold;
            margin: 32px 0 16px;
            color: var(--primary-text-color);
            text-align: center;
        }

        /* Style for the extra bold yellow text */
        .question .highlight-text {
            color: var(--primary-color);
            font-weight: bolder;
        }

        /* Confess list container - now responsible for its own scrolling and hidden scrollbar */
        .confess-list {
            background: var(--surface-color);
            border-radius: 16px;
            max-height: 320px; /* Max height for scrolling */
            overflow-y: auto;
            padding: 8px;
            padding-bottom: 50px; /* Adjusted padding to make space for sticky button and cover content */
            margin-bottom: 32px;
            border: 1px solid var(--border-color);
            /* Hide scrollbar for this specific section */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none;  /* IE and Edge */
            position: relative; /* Needed for sticky positioning of child */
        }
        .confess-list::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera*/
        }

        .confess-post {
            background: var(--card-background);
            padding: 16px;
            border-radius: 12px;
            margin: 8px;
            text-align: left;
            border: 1px solid transparent;
            transition: all 0.3s ease;
            margin-bottom: 16px; /* Added margin for spacing between posts */
        }
        .confess-post:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            border-color: var(--primary-color);
        }

        .actions {
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 14px;
            margin-top: 12px;
            color: var(--secondary-text-color);
        }
        .actions span {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .actions button {
            background: none;
            border: none;
            color: var(--secondary-text-color);
            cursor: pointer;
            padding: 4px 8px; /* Adjusted padding for reaction buttons */
            border-radius: 8px;
            transition: background 0.2s ease, color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .actions button:hover {
            background: rgba(253, 224, 71, 0.1); /* Subtle hover background */
            color: var(--primary-color);
        }
        .actions button.active { /* Style for active reaction */
            color: var(--primary-color);
            background: rgba(253, 224, 71, 0.2);
        }
        .actions button svg {
            width: 16px;
            height: 16px;
        }

        /* Comment Section Styles */
        .comments-section {
            margin-top: 20px;
            border-top: 1px solid var(--border-color);
            padding-top: 15px;
        }
        .comments-list {
            max-height: 150px; /* Max height for comments list */
            overflow-y: auto;
            margin-bottom: 10px;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none;  /* IE and Edge */
        }
        .comments-list::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera*/
        }
        .comment-item {
            background: var(--background-color);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 13px;
            color: var(--primary-text-color);
            text-align: left;
        }
        .comment-item strong {
            color: var(--primary-color);
            margin-right: 5px;
        }
        .comment-input-wrapper {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .comment-input-wrapper input {
            flex-grow: 1;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--background-color);
            color: var(--primary-text-color);
            font-size: 14px;
        }
        .comment-input-wrapper button {
            width: auto; /* Override 100% width from general button style */
            padding: 8px 15px;
            font-size: 14px;
            border-radius: 8px;
        }
        .comment-input-wrapper input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 5px rgba(253, 224, 71, 0.2);
        }
        .comment-char-count {
            font-size: 12px;
            color: var(--secondary-text-color);
            text-align: right;
            margin-top: 4px;
        }
        .comment-char-count.warning {
            color: red;
        }

        /* Confess form now sticky inside confess-list */
        .confess-form {
            background: var(--surface-color);
            padding: 10px; /* Adjusted padding to make it tighter */
            border-radius: 16px; /* Keep top radius */
            border-bottom-left-radius: 16px; /* Match list bottom radius */
            border-bottom-right-radius: 16px; /* Match list bottom radius */
            border: 1px solid var(--border-color);
            border-top: 1px solid var(--border-color); /* Add top border to separate from posts */
            margin-bottom: 0; /* Remove margin as it's sticky */
            position: sticky; /* Make it stick */
            bottom: 0; /* Stick to the bottom of its parent scroll container */
            z-index: 10; /* Ensure it's above scrolling posts */
            box-sizing: border-box; /* Include padding and border in element's total width and height */
            width: calc(100% - 16px); /* Adjust width to fit inside confess-list padding */
            left: 8px; /* Align with left padding of confess-list */
        }

        button {
            width: 100%;
            background: var(--primary-color);
            color: #111;
            border: none;
            padding: 14px;
            font-weight: bold;
            font-size: 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: var(--font-heading);
        }
        button:hover {
            background: #ffc107;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(253, 224, 71, 0.2);
        }

        .email-section {
            margin-top: 40px;
            padding: 24px;
            background: var(--surface-color);
            border-radius: 16px;
            border: 1px solid var(--border-color);
        }
        .email-section p {
            margin: 0 0 16px 0;
            font-size: 14px;
            color: var(--primary-text-color);
        }

        .email-section input {
            width: 100%;
            box-sizing: border-box;
            padding: 14px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: var(--background-color);
            color: var(--primary-text-color);
            font-size: 16px;
            font-family: var(--font-main);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            text-align: center;
        }
        .email-section input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 10px rgba(253, 224, 71, 0.2);
        }

        .email-section button {
            margin-top: 16px;
        }

        /* Custom Modal Styles (for confession input and success message) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0; /* Reverted */
            visibility: hidden; /* Reverted */
            transition: opacity 0.3s ease, visibility 0.3s ease; /* Reverted */
            z-index: 1000;
        }
        .modal-overlay.show {
            opacity: 1; /* Reverted */
            visibility: visible; /* Reverted */
        }
        .modal-content {
            background: var(--surface-color);
            padding: 24px;
            border-radius: 16px;
            width: 90%;
            max-width: 380px;
            text-align: center;
            border: 1px solid var(--border-color);
            transform: scale(0.9); /* Reverted */
            transition: transform 0.3s ease; /* Reverted */
            position: relative;
        }
        .modal-overlay.show .modal-content { /* Re-added this block */
            transform: scale(1);
        }
        .modal-content h3 {
            margin-top: 0;
            margin-bottom: 16px;
            color: var(--primary-color);
            font-family: var(--font-heading);
        }
        .modal-content p {
            margin-bottom: 20px;
            color: var(--secondary-text-color);
        }
        .modal-textarea {
            width: 100%;
            box-sizing: border-box;
            background: var(--background-color);
            color: var(--primary-text-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 14px;
            font-size: 16px;
            resize: none;
            margin-bottom: 16px;
            font-family: var(--font-main);
        }
        .alter-input-wrapper {
            display: flex;
            align-items: center;
            background: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding-left: 14px;
            margin-bottom: 20px;
        }
        .alter-input-wrapper span {
            color: var(--secondary-text-color);
            font-size: 16px;
        }
        .modal-input {
            flex-grow: 1;
            border: none;
            background: transparent;
            color: var(--primary-text-color);
            font-size: 16px;
            padding: 14px;
        }
        .modal-input:focus {
            outline: none;
        }
        .modal-actions {
            display: flex;
            gap: 12px;
        }
        .modal-actions button { /* Specific style for buttons within modal-actions */
            width: 100%; /* Ensure buttons inside modal-actions take full width */
        }


        /* Quotes Section Styles */
        .quotes-section {
            margin-bottom: 32px;
        }
        .quotes-slider-wrapper {
            position: relative;
            width: 100%;
        }
        .quotes-slider {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
        }
        .quotes-slider::-webkit-scrollbar {
            display: none; /* Safari and Chrome */
        }
        .quote-slide {
            flex: 0 0 100%;
            width: 100%;
            scroll-snap-align: center;
            padding: 0;
            box-sizing: border-box;
        }
        .quote-slide svg {
            width: 100%;
            height: auto;
            border-radius: 16px;
        }
        .slider-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 100%;
            left: 0;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
        }
        .slider-nav button {
            pointer-events: all;
            background: rgba(0,0,0,0.3);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .slider-nav button#prevQuote {
            transform: translateX(-50%);
        }
        .slider-nav button#nextQuote {
            transform: translateX(50%);
        }
        .quote-actions {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-top: 16px;
        }
        .quote-actions button {
            background: none;
            border: none;
            color: var(--secondary-text-color);
            cursor: pointer;
            padding: 8px;
            display: flex;
            flex-direction: column; /* Stack icon and text vertically */
            align-items: center; /* Center horizontally */
            justify-content: center; /* Center vertically */
            gap: 4px; /* Reduced gap between icon and text */
            font-size: 14px;
            opacity: 0.8;
            transition: opacity 0.2s ease;
        }
        .quote-actions button:hover {
            opacity: 1;
            color: var(--primary-text-color);
        }
        .quote-actions svg {
            width: 20px;
            height: 20px;
        }

        /* Toast/Snackbar message for "Copied!" and success messages */
        .toast-message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--primary-color);
            color: #111;
            padding: 10px 20px;
            border-radius: 8px;
            font-family: var(--font-main);
            font-weight: bold;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            z-index: 1001;
        }
        .toast-message.show {
            opacity: 1;
            visibility: visible;
        }

        /* Talk to Selfie specific styles */
        .talk-to-selfie-modal-content {
            max-width: 500px; /* Slightly wider for chat */
            height: 80vh; /* Take more vertical space */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .chat-history {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 15px;
            background: var(--background-color);
            text-align: left;
            display: flex;
            flex-direction: column;
            gap: 10px;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none;  /* IE and Edge */
        }
        .chat-history::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera*/
        }

        .chat-message {
            padding: 8px 12px;
            border-radius: 12px;
            max-width: 85%;
        }

        .chat-message.user {
            background: #4a4a4a;
            color: var(--primary-text-color);
            align-self: flex-end; /* Align to right */
            border-bottom-right-radius: 4px;
        }

        .chat-message.selfie {
            background: var(--primary-color);
            color: #111;
            align-self: flex-start; /* Align to left */
            border-bottom-left-radius: 4px;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 10px;
        }

        .chat-input-wrapper input {
            flex-grow: 1;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: var(--background-color);
            color: var(--primary-text-color);
            font-size: 16px;
        }
        .chat-input-wrapper input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 5px rgba(253, 224, 71, 0.2);
        }

        .chat-input-wrapper button {
            width: auto;
            padding: 12px 20px;
            font-size: 16px;
        }
        .loading-indicator {
            text-align: center;
            margin-top: 10px;
            font-style: italic;
            color: var(--secondary-text-color);
        }

        /* Floating Action Button (FAB) styles */
        .floating-action-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: var(--primary-color);
            color: #111; /* Dark text for yellow background */
            border: none;
            border-radius: 50%; /* Make it circular */
            box-shadow: 0 4px 15px rgba(0,0,0,0.4); /* Subtle shadow for floating effect */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 30px; /* Large emoji size */
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 999; /* Ensure it's above other content */
            font-family: 'Inter', sans-serif; /* Use Inter for emoji */
            font-weight: normal; /* Reset font weight */
        }

        .floating-action-button:hover {
            background: #ffc107;
            transform: translateY(-3px) scale(1.05); /* Slight lift and scale on hover */
            box-shadow: 0 6px 20px rgba(0,0,0,0.5);
        }

        /* New style for character count */
        .char-count {
            font-size: 12px;
            color: var(--secondary-text-color);
            text-align: right;
            margin-top: -10px; /* Adjust margin to be closer to textarea */
            margin-bottom: 16px; /* Space before next element */
        }
        .char-count.warning {
            color: red;
        }

    </style>
</head>
<body>
    <div class="container">
        <h2>Manifesto Selfify</h2>
        <div class="poem">
            Sekarang Dunia makin berisik, orang makin toxic
            dan Sosmed? Udah gak asik.

            Kalau hati lo gak terusik, 
            Mungkin lo beneran lagi sakit.

            Dan ketika elo Lelah ngejar validasi?

            <span style="color: var(--primary-color);">"Selfify hadir bukan buat pelarian,
            tapi tempat lo pulang ke diri lo sendiri."</span>

            Karena hidup gak cuma buat dilewatin
            tapi dijalanin dengan arah & makna.
        </div>
        
        <div class="quotes-section">
            <div class="quotes-slider-wrapper">
                <div class="quotes-slider" id="quotesSlider">
                    <div class="quote-slide">
                        <svg viewBox="0 0 300 300" xmlns="http://www.w3.org/2000/svg">
                            <rect width="100%" height="100%" fill="#1e1e1e"/>
                            <text x="50%" y="45%" dominant-baseline="middle" text-anchor="middle" fill="#e5e5e5" font-size="20" font-family="'Inter', sans-serif" font-weight="bold">
                                <tspan x="50%" dy="-1.2em">Rehat itu bukan mager,</tspan>
                                <tspan x="50%" dy="1.2em">tapi investasi waras.</tspan>
                            </text>
                        </svg>
                    </div>
                    <div class="quote-slide">
                        <svg viewBox="0 0 300 300" xmlns="http://www.w3.org/2000/svg">
                            <rect width="100%" height="100%" fill="#fde047"/>
                            <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#121212" font-size="24" font-family="'Lexend', sans-serif" font-weight="bold">
                                <tspan x="50%" dy="-0.6em">Cukup itu mindset,</tspan>
                                <tspan x="50%" dy="1.2em">bukan saldo.</tspan>
                            </text>
                        </svg>
                    </div>
                    <div class="quote-slide">
                        <svg viewBox="0 0 300 300" xmlns="http://www.w3.org/2000/svg">
                            <rect width="100%" height="100%" fill="#2a2a2a"/>
                            <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#e5e5e5" font-size="18" font-family="'Inter', sans-serif">
                                <tspan x="50%" dy="-1.5em">Hidup bukan lomba,</tspan>
                                <tspan x="50%" dy="1.2em">tiap orang punya</tspan>
                                <tspan x="50%" dy="1.2em">pace-nya sendiri.</tspan>
                            </text>
                        </svg>
                    </div>
                    <div class="quote-slide">
                        <svg viewBox="0 0 300 300" xmlns="http://www.w3.org/2000/svg">
                            <rect width="100%" height="100%" fill="#1e1e1e"/>
                            <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#e5e5e5" font-size="20" font-family="'Inter', sans-serif" font-weight="bold">
                                <tspan x="50%" dy="-0.6em">Vibes positif?</tspan>
                                <tspan x="50%" dy="1.2em">Auto-healing.</tspan>
                            </text>
                        </svg>
                    </div>
                    <div class="quote-slide">
                        <svg viewBox="0 0 300 300" xmlns="http://www.w3.org/2000/svg">
                            <rect width="100%" height="100%" fill="#fde047"/>
                            <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#121212" font-size="20" font-family="'Lexend', sans-serif" font-weight="bold">
                                <tspan x="50%" dy="-0.6em">Self-care itu bukan egois,</tspan>
                                <tspan x="50%" dy="1.2em">tapi biar gak oleng.</tspan>
                            </text>
                        </svg>
                    </div>
                    <div class="quote-slide">
                        <svg viewBox="0 0 300 300" xmlns="http://www.w3.org/2000/svg">
                            <rect width="100%" height="100%" fill="#2a2a2a"/>
                            <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#e5e5e5" font-size="18" font-family="'Inter', sans-serif">
                                <tspan x="50%" dy="-0.6em">Kalo burnout itu real,</tspan>
                                <tspan x="50%" dy="1.2em">istirahat juga harus total.</tspan>
                            </text>
                        </svg>
                    </div>
                    <div class="quote-slide">
                        <svg viewBox="0 0 300 300" xmlns="http://www.w3.org/2000/svg">
                            <rect width="100%" height="100%" fill="#1e1e1e"/>
                            <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#e5e5e5" font-size="20" font-family="'Inter', sans-serif" font-weight="bold">
                                <tspan x="50%" dy="-0.6em">Self-improvement itu wajib,</tspan>
                                <tspan x="50%" dy="1.2em">biar gak stuck di situ-situ aja.</tspan>
                            </text>
                        </svg>
                    </div>
                    <div class="quote-slide">
                        <svg viewBox="0 0 300 300" xmlns="http://www.w3.org/2000/svg">
                            <rect width="100%" height="100%" fill="#fde047"/>
                            <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#121212" font-size="20" font-family="'Lexend', sans-serif" font-weight="bold">
                                <tspan x="50%" dy="-0.6em">Dulu FOMO, sekarang JOMO.</tspan>
                                <tspan x="50%" dy="1.2em">Enjoy your own pace.</tspan>
                            </text>
                        </svg>
                    </div>
                </div>
                <div class="slider-nav">
                    <button id="prevQuote">‚Äπ</button>
                    <button id="nextQuote">‚Ä∫</button>
                </div>
            </div>
            <div class="quote-actions">
                <button id="shareQuoteBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M7.217 10.907a2.25 2.25 0 1 0 0 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186 9.566-5.314m-9.566 7.5 9.566 5.314m0 0a2.25 2.25 0 1 0 3.935 2.186 2.25 2.25 0 0 0-3.935-2.186Zm0-12.814a2.25 2.25 0 1 0 3.933-2.186 2.25 2.25 0 0 0-3.933 2.186Z" /></svg>
                    Share
                </button>
                <button id="downloadQuoteBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                    Download
                </button>
            </div>
        </div>

        <div class="question">Hal apa yang paling lo gak mau<br/><span class="highlight-text">orang tau tentang elo?</span></div>

        <div class="confess-list" id="confessList">
            <!-- Posts are dynamically added -->
            <div id="loadingMessage" style="color: var(--secondary-text-color); padding: 20px;">Memuat pengakuan...</div>
            
            <!-- Confess form now sticky inside confess-list -->
            <div class="confess-form">
                <button id="openConfessModalBtn">Curhat? Confess? Boleh banget.</button>
            </div>
        </div>

        <div class="email-section">
            <p>Drop email lo, and let‚Äôs be part of the first <b style="color: var(--primary-color);">Selfify</b> circle. We‚Äôve got cool features yang gak cuman keren, tapi juga super relatable‚Äîtailored just for you.</p>
            <input type="email" id="emailInput" placeholder="you@email.com" />
            <button id="submitEmailBtn">Kirim üîî</button>
        </div>
    </div>

    <!-- Floating Talk to Selfie Button -->
    <button id="openTalkToSelfieModalBtn" class="floating-action-button">ü§ñ</button>

    <!-- Custom Modal for New Confession -->
    <div class="modal-overlay" id="confessModal">
        <div class="modal-content">
            <h3>Buat Pengakuan</h3>
            <textarea id="modalConfessText" class="modal-textarea" rows="5" placeholder="Tulis pengakuan lo di sini..."></textarea>
            <div class="char-count" id="modalConfessCharCount">0/500</div> <!-- New character counter -->
            <div class="alter-input-wrapper">
                <span>@</span>
                <input type="text" id="modalAlterName" class="modal-input" placeholder="nama_alter_lo">
            </div>
            <div class="modal-actions">
                <button id="cancelConfess" style="background: #444;">Batal</button>
                <button id="submitConfess">Kirim</button>
            </div>
        </div>
    </div>

    <!-- Custom Modal for Success Message -->
    <div class="modal-overlay" id="successModal">
        <div class="modal-content">
            <h3>Terkirim! üôè</h3>
            <p>Pengakuan lo udah aman di sini. Terima kasih sudah berbagi.</p>
            <button id="closeSuccessModal">Tutup</button>
        </div>
    </div>

    <!-- Custom Modal for Error Message -->
    <div class="modal-overlay" id="errorModal">
        <div class="modal-content">
            <h3>Error! üòî</h3>
            <p id="errorMessage">Terjadi kesalahan saat menyimpan pengakuan Anda. Silakan coba lagi.</p>
            <button id="closeErrorModal">Tutup</button>
        </div>
    </div>

    <!-- Talk to Selfie Modal -->
    <div class="modal-overlay" id="talkToSelfieModal">
        <div class="modal-content talk-to-selfie-modal-content">
            <h3>Talk to Selfie ü§ñ</h3>
            <div class="chat-history" id="chatHistoryDisplay">
                <!-- Chat messages will be appended here -->
                <div class="chat-message selfie">Halo! Ada yang bisa Selfie bantu?</div>
            </div>
            <div class="loading-indicator" id="selfieLoadingIndicator" style="display: none;">Selfie sedang berpikir...</div>
            <div class="chat-input-wrapper">
                <input type="text" id="selfieChatInput" placeholder="Ketik pesanmu di sini..." />
                <button id="sendSelfieMessageBtn">Kirim</button>
            </div>
            <div class="modal-actions" style="margin-top: 15px;">
                <button id="closeTalkToSelfieModalBtn" style="background: #444;">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, doc, updateDoc, arrayUnion, arrayRemove, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration (DO NOT EDIT)
        // These variables are provided by the Canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let userId = null; // Untuk menyimpan ID pengguna yang terautentikasi

        // --- DOM Elements ---
        const confessList = document.getElementById('confessList');
        const loadingMessage = document.getElementById('loadingMessage');
        
        const openConfessModalBtn = document.getElementById('openConfessModalBtn');
        const confessModal = document.getElementById('confessModal');
        const successModal = document.getElementById('successModal');
        const errorModal = document.getElementById('errorModal'); 
        
        const modalConfessText = document.getElementById('modalConfessText');
        const modalConfessCharCount = document.getElementById('modalConfessCharCount'); // New element
        const modalAlterName = document.getElementById('modalAlterName');

        const submitConfessBtn = document.getElementById('submitConfess');
        const cancelConfessBtn = document.getElementById('cancelConfess');
        const closeSuccessBtn = document.getElementById('closeSuccessModal');
        const closeErrorBtn = document.getElementById('closeErrorModal'); 
        const errorMessageDisplay = document.getElementById('errorMessage'); 

        const quotesSlider = document.getElementById('quotesSlider');
        const prevQuoteBtn = document.getElementById('prevQuote');
        const nextQuoteBtn = document.getElementById('nextQuote');
        const shareQuoteBtn = document.getElementById('shareQuoteBtn');
        const downloadQuoteBtn = document.getElementById('downloadQuoteBtn');

        const emailInput = document.getElementById('emailInput'); 
        const submitEmailBtn = document.getElementById('submitEmailBtn'); 

        // NEW: Talk to Selfie Elements
        const openTalkToSelfieModalBtn = document.getElementById('openTalkToSelfieModalBtn');
        const talkToSelfieModal = document.getElementById('talkToSelfieModal');
        const chatHistoryDisplay = document.getElementById('chatHistoryDisplay');
        const selfieChatInput = document.getElementById('selfieChatInput');
        const sendSelfieMessageBtn = document.getElementById('sendSelfieMessageBtn');
        const closeTalkToSelfieModalBtn = document.getElementById('closeTalkToSelfieModalBtn');
        const selfieLoadingIndicator = document.getElementById('selfieLoadingIndicator');

        // Chat history for LLM context
        let chatHistory = [{ role: "model", parts: [{ text: "Halo! Ada yang bisa Selfie bantu?" }] }];

        // --- Functions ---

        /**
         * Menampilkan modal dengan menambahkan kelas 'show' dan mencegah body scrolling.
         * @param {HTMLElement} modalElement - Elemen modal yang akan ditampilkan.
         */
        function showModal(modalElement) {
            console.log('showModal called for:', modalElement.id); // Debugging log
            modalElement.classList.add('show');
            document.body.classList.add('modal-open'); 
        }

        /**
         * Menyembunyikan modal dengan menghapus kelas 'show' dan mengaktifkan kembali body scrolling.
         * @param {HTMLElement} modalElement - Elemen modal yang akan disembunyikan.
         */
        function hideModal(modalElement) {
            console.log('hideModal called for:', modalElement.id); // Debugging log
            modalElement.classList.remove('show');
            document.body.classList.remove('modal-open'); 
        }

        /**
         * Menampilkan pesan toast sementara.
         * @param {string} message - Pesan yang akan ditampilkan.
         */
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast-message';
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('show');
            }, 10); 

            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove(), { once: true });
            }, 2000); 
        }

        /**
         * Merender daftar pengakuan ke DOM, termasuk reaksi dan komentar.
         * @param {Array<Object>} confessionsData - Array objek pengakuan.
         */
        function renderConfessions(confessionsData) {
            console.log('renderConfessions called.'); // Debugging log
            // Store the current scroll position
            const currentScrollTop = confessList.scrollTop;
            const isScrolledToBottom = confessList.scrollHeight - confessList.clientHeight <= currentScrollTop + 1; // +1 for tolerance

            confessList.innerHTML = ''; 

            // --- Add dummy confessions for visualization ---
            const dummyConfessions = [
                {
                    id: 'dummy1',
                    text: 'Pengakuan dummy pertama: Aku sering merasa tidak cukup baik, meskipun sudah berusaha keras.',
                    alterName: 'ShadowSelf',
                    likes: [], loves: [], fires: [],
                    timestamp: new Date(Date.now() - 3600000) // 1 hour ago
                },
                {
                    id: 'dummy2',
                    text: 'Pengakuan dummy kedua: Sulit sekali untuk jujur pada diri sendiri tentang apa yang sebenarnya aku inginkan.',
                    alterName: 'InnerVoice',
                    likes: [], loves: [], fires: [],
                    timestamp: new Date(Date.now() - 7200000) // 2 hours ago
                },
                {
                    id: 'dummy3',
                    text: 'Pengakuan dummy ketiga: Kadang aku hanya ingin menghilang dari semua tekanan ini.',
                    alterName: 'QuietSoul',
                    likes: [], loves: [], fires: [],
                    timestamp: new Date(Date.now() - 10800000) // 3 hours ago
                }
            ];
            // Combine dummy data with actual fetched data
            const allConfessions = [...dummyConfessions, ...confessionsData];

            // Add posts first, excluding the sticky form
            allConfessions.forEach((confess) => {
                const post = document.createElement('div');
                post.className = 'confess-post';
                post.dataset.id = confess.id; 
                post.innerHTML = `
                    ${confess.text}
                    <div class="actions">
                        <button class="reaction-btn ${confess.likes?.includes(userId) ? 'active' : ''}" data-type="likes" data-id="${confess.id}">
                            ‚ù§Ô∏è <span class="count">${confess.likes?.length || 0}</span>
                        </button>
                        <button class="reaction-btn ${confess.loves?.includes(userId) ? 'active' : ''}" data-type="loves" data-id="${confess.id}">
                            üíñ <span class="count">${confess.loves?.length || 0}</span>
                        </button>
                        <button class="reaction-btn ${confess.fires?.includes(userId) ? 'active' : ''}" data-type="fires" data-id="${confess.id}">
                            üî• <span class="count">${confess.fires?.length || 0}</span>
                        </button>
                        <button class="share-confession-btn" data-id="${confess.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M7.217 10.907a2.25 2.25 0 1 0 0 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186 9.566-5.314m-9.566 7.5 9.566 5.314m0 0a2.25 2.25 0 1 0 3.935 2.186 2.25 2.25 0 0 0-3.935-2.186Zm0-12.814a2.25 2.25 0 1 0 3.933-2.186 2.25 2.25 0 0 0-3.933 2.186Z" />
                            </svg>
                            Bagikan
                        </button>
                    </div>
                    <div class="comments-section">
                        <h4>Komentar:</h4>
                        <div class="comments-list" id="comments-list-${confess.id}">
                            <!-- Komentar akan dimuat secara dinamis di sini -->
                            <div style="color: var(--secondary-text-color); font-size: 12px; text-align: center; padding: 10px;">Memuat komentar...</div>
                        </div>
                        <div class="comment-input-wrapper">
                            <input type="text" id="comment-input-${confess.id}" placeholder="Tulis komentar (max 250 karakter)" maxlength="250">
                            <button class="submit-comment-btn" data-id="${confess.id}">Kirim</button>
                        </div>
                        <div class="comment-char-count" id="comment-char-count-${confess.id}">0/250</div>
                    </div>
                `;
                confessList.appendChild(post);

                // Setup event listeners for reaction buttons
                post.querySelectorAll('.reaction-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const confessionId = e.currentTarget.dataset.id;
                        const reactionType = e.currentTarget.dataset.type;
                        toggleReaction(confessionId, reactionType);
                    });
                });

                // Setup event listener for comment submission
                post.querySelector(`.submit-comment-btn`).addEventListener('click', (e) => {
                    const confessionId = e.currentTarget.dataset.id;
                    submitComment(confessionId);
                });

                // Setup character count for comment input
                const commentInput = post.querySelector(`#comment-input-${confess.id}`);
                const charCountDisplay = post.querySelector(`#comment-char-count-${confess.id}`);
                commentInput.addEventListener('input', () => {
                    const currentLength = commentInput.value.length;
                    charCountDisplay.textContent = `${currentLength}/250`;
                    if (currentLength >= 240) { 
                        charCountDisplay.classList.add('warning');
                    } else {
                        charCountDisplay.classList.remove('warning');
                    }
                });

                // Setup real-time listener for comments on this specific post
                // Only setup listener for actual Firestore posts, not dummies
                if (!confess.id.startsWith('dummy')) {
                    setupCommentsListener(confess.id);
                    // Setup event listener for share button for real confessions
                    const shareButton = post.querySelector(`.share-confession-btn`);
                    if (shareButton) {
                        shareButton.addEventListener('click', () => {
                            shareConfession(confess.text); // Pass the text directly
                        });
                    }
                } else {
                    // For dummy posts, just show "No comments" initially
                    const commentsListElement = document.getElementById(`comments-list-${confess.id}`);
                    if (commentsListElement) {
                        commentsListElement.innerHTML = '<div style="color: var(--secondary-text-color); font-size: 12px; text-align: center; padding: 10px;">Belum ada komentar.</div>';
                    }
                    // Disable share button for dummy posts
                    const shareButton = post.querySelector(`.share-confession-btn`);
                    if (shareButton) {
                        shareButton.disabled = true;
                        shareButton.style.opacity = '0.5';
                        shareButton.style.cursor = 'not-allowed';
                    }
                }
            });

            // Add the sticky form after all posts
            const stickyFormHtml = `
                <div class="confess-form">
                    <button id="openConfessModalBtn">Curhat? Confess? Boleh banget.</button>
                </div>
            `;
            confessList.insertAdjacentHTML('beforeend', stickyFormHtml);

            // Re-attach event listener for the sticky button
            const newOpenConfessModalBtn = confessList.querySelector('#openConfessModalBtn');
            if (newOpenConfessModalBtn) {
                console.log('openConfessModalBtn found and listener re-attached.'); // Debugging log
                newOpenConfessModalBtn.addEventListener('click', () => {
                    console.log('openConfessModalBtn clicked!'); // Debugging log
                    showModal(confessModal);
                });
            } else {
                console.error('openConfessModalBtn not found after rendering confessions.'); // Debugging log
            }


            if (allConfessions.length === 0) { // Check against allConfessions, including dummies
                confessList.innerHTML = '<div style="color: var(--secondary-text-color); padding: 20px;">Belum ada pengakuan. Jadilah yang pertama!</div>' + stickyFormHtml;
            }

            // Restore scroll position or scroll to bottom if it was already there
            if (isScrolledToBottom) {
                confessList.scrollTop = confessList.scrollHeight;
            } else {
                confessList.scrollTop = currentScrollTop;
            }
        }

        /**
         * Mengelola penambahan atau penghapusan reaksi (like, love, fire) pada pengakuan.
         * @param {string} confessionId - ID dokumen pengakuan.
         * @param {string} reactionType - Tipe reaksi ('likes', 'loves', 'fires').
         */
        async function toggleReaction(confessionId, reactionType) {
            if (!userId) {
                showErrorModal('Anda perlu login untuk memberikan reaksi.');
                return;
            }
            if (confessionId.startsWith('dummy')) {
                showToast('Tidak bisa bereaksi pada pengakuan dummy.');
                return;
            }

            const confessionRef = doc(db, `artifacts/${appId}/public/data/confessions`, confessionId);
            try {
                const docSnap = await getDoc(confessionRef);
                if (docSnap.exists()) {
                    const currentReactions = docSnap.data()[reactionType] || [];
                    if (currentReactions.includes(userId)) {
                        // Jika sudah ada, hapus reaksi
                        await updateDoc(confessionRef, {
                            [reactionType]: arrayRemove(userId)
                        });
                    } else {
                        // Jika belum ada, tambahkan reaksi
                        // Pertama, hapus reaksi lain dari pengguna ini untuk memastikan hanya 1 opsi
                        const allReactionTypes = ['likes', 'loves', 'fires'];
                        for (const type of allReactionTypes) {
                            if (type !== reactionType) {
                                const otherReactions = docSnap.data()[type] || [];
                                if (otherReactions.includes(userId)) {
                                    await updateDoc(confessionRef, {
                                        [type]: arrayRemove(userId)
                                    });
                                }
                            }
                        }
                        // Kemudian, tambahkan reaksi yang dipilih
                        await updateDoc(confessionRef, {
                            [reactionType]: arrayUnion(userId)
                        });
                    }
                }
            } catch (error) {
                console.error(`Error toggling ${reactionType}:`, error);
                showErrorModal(`Gagal memberikan reaksi. Silakan coba lagi.`);
            }
        }

        /**
         * Merender daftar komentar untuk pengakuan tertentu.
         * @param {string} confessionId - ID dokumen pengakuan.
         * @param {Array<Object>} commentsData - Array objek komentar.
         */
        function renderComments(confessionId, commentsData) {
            const commentsListElement = document.getElementById(`comments-list-${confessionId}`);
            if (!commentsListElement) return;

            commentsListElement.innerHTML = ''; 
            if (commentsData.length === 0) {
                commentsListElement.innerHTML = '<div style="color: var(--secondary-text-color); font-size: 12px; text-align: center; padding: 10px;">Belum ada komentar.</div>';
                return;
            }

            commentsData.forEach(comment => {
                const commentItem = document.createElement('div');
                commentItem.className = 'comment-item';
                commentItem.innerHTML = `<strong>${comment.alterName || 'Anonim'}:</strong> ${comment.text}`;
                commentsListElement.appendChild(commentItem);
            });
            commentsListElement.scrollTop = commentsListElement.scrollHeight; 
        }

        /**
         * Menyiapkan listener real-time untuk komentar pada pengakuan tertentu.
         * @param {string} confessionId - ID dokumen pengakuan.
         */
        function setupCommentsListener(confessionId) {
            const commentsCollectionRef = collection(db, `artifacts/${appId}/public/data/confessions/${confessionId}/comments`);
            const q = query(commentsCollectionRef); 

            onSnapshot(q, (snapshot) => {
                const fetchedComments = [];
                snapshot.forEach((doc) => {
                    fetchedComments.push({ id: doc.id, ...doc.data() });
                });
                fetchedComments.sort((a, b) => (a.timestamp?.toDate() || 0) - (b.timestamp?.toDate() || 0));
                renderComments(confessionId, fetchedComments);
            }, (error) => {
                console.error(`Error fetching comments for ${confessionId}:`, error);
                const commentsListElement = document.getElementById(`comments-list-${confessionId}`);
                if (commentsListElement) {
                    commentsListElement.innerHTML = '<div style="color: red; font-size: 12px; text-align: center; padding: 10px;">Gagal memuat komentar.</div>';
                }
            });
        }

        /**
         * Mengirimkan komentar baru ke Firestore.
         * @param {string} confessionId - ID dokumen pengakuan.
         */
        async function submitComment(confessionId) {
            if (!userId) {
                showErrorModal('Anda perlu login untuk mengirim komentar.');
                return;
            }
            if (confessionId.startsWith('dummy')) {
                showToast('Tidak bisa mengirim komentar pada pengakuan dummy.');
                return;
            }

            const commentInput = document.getElementById(`comment-input-${confessionId}`);
            const commentText = commentInput.value.trim();
            const COMMENT_MAX_LENGTH = 250;

            if (commentText.length === 0) {
                commentInput.style.borderColor = 'red';
                setTimeout(() => { commentInput.style.borderColor = 'var(--border-color)'; }, 1500);
                return;
            }
            if (commentText.length > COMMENT_MAX_LENGTH) {
                showErrorModal(`Komentar terlalu panjang. Maksimal ${COMMENT_MAX_LENGTH} karakter.`);
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/confessions/${confessionId}/comments`), {
                    text: commentText,
                    alterName: "Anonim", 
                    timestamp: serverTimestamp(),
                    userId: userId
                });
                commentInput.value = ''; 
                showToast('Komentar terkirim!');
            } catch (error) {
                console.error("Error adding comment: ", error);
                showErrorModal('Terjadi kesalahan saat mengirim komentar. Silakan coba lagi.');
            }
        }


        /**
         * Menyiapkan listener real-time untuk pengakuan dari Firestore.
         */
        function setupConfessionsListener() {
            if (!db) {
                console.error("Firestore is not initialized.");
                return;
            }
            
            // Define the collection path for public data
            const confessionsCollectionRef = collection(db, `artifacts/${appId}/public/data/confessions`);
            
            // Create a query to order confessions by creation date (newest first)
            const q = query(confessionsCollectionRef); 

            // Set up a real-time listener
            onSnapshot(q, (snapshot) => {
                const fetchedConfessions = [];
                snapshot.forEach((doc) => {
                    fetchedConfessions.push({ id: doc.id, ...doc.data() }); // Include doc.id
                });
                // Sort by timestamp in descending order (newest first) in memory
                fetchedConfessions.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
                renderConfessions(fetchedConfessions);
                if (loadingMessage) loadingMessage.style.display = 'none'; // Hide loading message
            }, (error) => {
                console.error("Error fetching confessions: ", error);
                if (loadingMessage) loadingMessage.textContent = 'Gagal memuat pengakuan.';
                showErrorModal('Gagal memuat pengakuan. Silakan coba refresh halaman.');
            });
        }

        /**
         * Menangani pengiriman pengakuan baru ke Firestore.
         */
        async function submitConfession() {
            const text = modalConfessText.value.trim();
            const alter = modalAlterName.value.trim();

            let isValid = true;
            
            // Basic validation: check if text and alterName are not empty
            if (text.length === 0) {
                modalConfessText.style.borderColor = 'red';
                setTimeout(() => { modalConfessText.style.borderColor = 'var(--border-color)'; }, 1500);
                isValid = false;
            } else if (text.length > CONFESS_MAX_LENGTH) { // New validation for max length
                showErrorModal(`Pengakuan terlalu panjang. Maksimal ${CONFESS_MAX_LENGTH} karakter.`);
                isValid = false;
            }
            
            if (alter.length === 0) {
                modalAlterName.parentElement.style.borderColor = 'red';
                setTimeout(() => { modalAlterName.parentElement.style.borderColor = 'var(--border-color)'; }, 1500);
                isValid = false;
            }

            if (!isValid) return; // Stop if validation fails
            
            try {
                // Ensure user is authenticated before adding data
                if (!userId) {
                    console.error("User not authenticated. Cannot submit confession.");
                    showErrorModal('Anda perlu login untuk mengirim pengakuan.');
                    return;
                }

                // Add a new document to the 'confessions' collection
                await addDoc(collection(db, `artifacts/${appId}/public/data/confessions`), {
                    text: text,
                    alterName: alter,
                    likes: [], // Initialize as empty array for user IDs
                    loves: [], // Initialize as empty array for user IDs
                    fires: [], // Initialize as empty array for user IDs
                    timestamp: serverTimestamp(), // Use server timestamp for consistent ordering
                    userId: userId // Store the user ID who made the confession
                });
                
                // Reset input fields
                modalConfessText.value = '';
                modalAlterName.value = '';
                
                // Hide confession modal and show success modal
                hideModal(confessModal);
                showModal(successModal);

            } catch (e) {
                console.error("Error adding document: ", e);
                showErrorModal('Terjadi kesalahan saat mengirim pengakuan. Silakan coba lagi.');
            }
        }

        /**
         * Menampilkan modal error dengan pesan tertentu.
         * @param {string} message - Pesan error yang akan ditampilkan.
         */
        function showErrorModal(message) {
            errorMessageDisplay.textContent = message;
            showModal(errorModal);
        }

        /**
         * Menangani pengiriman email (placeholder untuk Netlify Function).
         */
        async function submitEmail() {
            const email = emailInput.value.trim();
            if (!email) {
                emailInput.style.borderColor = 'red';
                setTimeout(() => { emailInput.style.borderColor = 'var(--border-color)'; }, 1500);
                showErrorModal('Email tidak boleh kosong.');
                return;
            }

            // --- Placeholder untuk pemanggilan Netlify Function ---
            // Nanti di sini akan ada kode untuk memanggil Netlify Function
            // yang akan mengirim email notifikasi ke admin.
            // Contoh:
            /*
            try {
                const response = await fetch('/.netlify/functions/notify-admin-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email, userId: userId })
                });
                if (!response.ok) {
                    throw new Error('Gagal mengirim notifikasi email.');
                }
                showToast('Email Anda telah terdaftar!');
                emailInput.value = ''; // Kosongkan input setelah sukses
            } catch (error) {
                console.error("Error submitting email:", error);
                showErrorModal('Gagal mendaftarkan email Anda. Silakan coba lagi.');
            }
            */
            // Untuk saat ini, kita akan langsung mengosongkan input dan menampilkan pesan sukses
            showToast('Email Anda telah terdaftar! (Notifikasi admin akan aktif setelah Netlify Function dikonfigurasi)');
            emailInput.value = ''; // Kosongkan input setelah sukses
        }

        /**
         * Mengunduh gambar quote yang sedang terlihat sebagai file SVG.
         */
        function downloadCurrentQuote() {
            // Calculate current slide index based on scroll position
            const slideWidth = quotesSlider.querySelector('.quote-slide').clientWidth;
            const currentIndex = Math.round(quotesSlider.scrollLeft / slideWidth);
            const currentSVG = quotesSlider.querySelectorAll('svg')[currentIndex];
            
            if (!currentSVG) {
                console.error("Tidak ada SVG ditemukan untuk diunduh.");
                showErrorModal('Tidak ada SVG ditemukan untuk diunduh.');
                return;
            }

            // Serialize SVG to string
            const serializer = new XMLSerializer();
            const svgString = serializer.serializeToString(currentSVG);
            const blob = new Blob([svgString], {type: "image/svg+xml"});
            const url = URL.createObjectURL(blob);
            
            // Create a temporary anchor element to trigger download
            const a = document.createElement('a');
            a.href = url;
            a.download = `selfify_quote_${currentIndex + 1}.svg`; // Suggest a filename
            document.body.appendChild(a);
            a.click(); // Programmatically click the link to start download
            document.body.removeChild(a); // Clean up the temporary link
            URL.revokeObjectURL(url); // Release the object URL
            showToast('Gambar diunduh!');
        }

        /**
         * Menyalin teks quote atau membagikan menggunakan Web Share API.
         */
        async function shareCurrentQuote() {
            const slideWidth = quotesSlider.querySelector('.quote-slide').clientWidth;
            const currentIndex = Math.round(quotesSlider.scrollLeft / slideWidth);
            const currentSVG = quotesSlider.querySelectorAll('svg')[currentIndex];

            if (!currentSVG) {
                console.error("Tidak ada SVG ditemukan untuk menyalin teks.");
                showErrorModal('Tidak ada SVG ditemukan untuk menyalin teks.');
                return;
            }

            // Extract text content from the SVG's <text> elements
            let quoteText = '';
            currentSVG.querySelectorAll('tspan').forEach(tspan => {
                quoteText += tspan.textContent + '\n';
            });
            quoteText = quoteText.trim(); // Remove trailing newline

            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Manifesto Selfify',
                        text: quoteText,
                        url: window.location.href 
                    });
                    showToast('Quote berhasil dibagikan!');
                } catch (error) {
                    console.error('Error sharing:', error);
                    // Fallback to copy if Web Share API fails or not supported
                    copyTextToClipboard(quoteText);
                    showToast('Teks quote disalin!');
                }
            } else {
                // Fallback to copy if Web Share API not supported
                copyTextToClipboard(quoteText);
                showToast('Teks quote disalin!');
            }
        }

        /**
         * Fungsi pembantu untuk menyalin teks ke clipboard.
         * @param {string} text - Teks yang akan disalin.
         */
        function copyTextToClipboard(text) {
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = text;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            document.execCommand('copy'); // Deprecated but widely supported in iframes
            document.body.removeChild(tempTextArea);
        }

        /**
         * Mengatur tampilan awal slider quotes.
         */
        function setupQuotesSlider() {
            if (quotesSlider) {
                quotesSlider.scrollLeft = 0; 
            }
        }

        /**
         * Mengirim pesan ke model bahasa besar (LLM) dan menampilkan responsnya.
         * Menggunakan exponential backoff untuk retry.
         * @param {string} userMessage - Pesan dari pengguna.
         */
        async function sendMessageToSelfie(userMessage) {
            if (!userMessage.trim()) return;

            // Add user message to chat history display
            const userMsgElement = document.createElement('div');
            userMsgElement.className = 'chat-message user';
            userMsgElement.textContent = userMessage;
            chatHistoryDisplay.appendChild(userMsgElement);
            chatHistoryDisplay.scrollTop = chatHistoryDisplay.scrollHeight; // Scroll to bottom

            // Add user message to chat history for LLM context
            chatHistory.push({ role: "user", parts: [{ text: userMessage }] });

            selfieChatInput.value = ''; // Clear input
            sendSelfieMessageBtn.disabled = true; // Disable send button
            selfieLoadingIndicator.style.display = 'block'; // Show loading indicator

            const MAX_RETRIES = 5;
            let retryCount = 0;
            let success = false;

            while (retryCount < MAX_RETRIES && !success) {
                try {
                    const payload = { contents: chatHistory };
                    const apiKey = ""; // If you want to use models other than gemini-2.5-flash-preview-05-20 or imagen-3.0-generate-002, provide an API key here. Otherwise, leave this as-is.
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && retryCount < MAX_RETRIES - 1) { // Too Many Requests
                            const delay = Math.pow(2, retryCount) * 1000; // Exponential backoff
                            console.warn(`Rate limit hit. Retrying in ${delay / 1000}s...`);
                            await new Promise(res => setTimeout(res, delay));
                            retryCount++;
                            continue; // Retry the loop
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const selfieResponseText = result.candidates[0].content.parts[0].text;
                        
                        // Add Selfie's response to chat history display
                        const selfieMsgElement = document.createElement('div');
                        selfieMsgElement.className = 'chat-message selfie';
                        selfieMsgElement.textContent = selfieResponseText;
                        chatHistoryDisplay.appendChild(selfieMsgElement);
                        chatHistoryDisplay.scrollTop = chatHistoryDisplay.scrollHeight; // Scroll to bottom

                        // Add Selfie's response to chat history for LLM context
                        chatHistory.push({ role: "model", parts: [{ text: selfieResponseText }] });
                        success = true; // Mark as success
                    } else {
                        throw new Error("Unexpected API response structure or missing content.");
                    }
                } catch (error) {
                    console.error("Error talking to Selfie:", error);
                    const errorMsgElement = document.createElement('div');
                    errorMsgElement.className = 'chat-message selfie';
                    errorMsgElement.textContent = "Maaf, Selfie sedang tidak bisa merespons. Coba lagi nanti.";
                    chatHistoryDisplay.appendChild(errorMsgElement);
                    chatHistoryDisplay.scrollTop = chatHistoryDisplay.scrollHeight;
                    break; // Exit loop on critical error
                } finally {
                    selfieLoadingIndicator.style.display = 'none'; // Hide loading indicator
                    sendSelfieMessageBtn.disabled = false; // Re-enable send button
                }
            }
        }


        // --- Event Listeners ---
        // Event listener untuk membuka modal pengakuan
        //openConfessModalBtn.addEventListener('click', () => { // This listener is now attached dynamically in renderConfessions
        //    showModal(confessModal);
        //});

        // Event listener untuk mengirim pengakuan baru
        submitConfessBtn.addEventListener('click', submitConfession);
        
        // Event listener untuk membatalkan pengakuan baru
        cancelConfessBtn.addEventListener('click', () => {
            hideModal(confessModal);
            modalConfessText.value = ''; // Clear textarea
            modalAlterName.value = ''; // Clear input
            modalConfessCharCount.textContent = `0/${CONFESS_MAX_LENGTH}`; // Reset char count
            modalConfessCharCount.classList.remove('warning'); // Remove warning
        });

        // Event listener untuk menutup modal pesan sukses
        closeSuccessBtn.addEventListener('click', () => {
            hideModal(successModal);
        });

        // Event listener untuk menutup modal pesan error
        closeErrorBtn.addEventListener('click', () => {
            hideModal(errorModal);
        });

        // Event listener untuk navigasi ke quote sebelumnya
        prevQuoteBtn.addEventListener('click', () => {
            quotesSlider.scrollBy({ left: -quotesSlider.clientWidth, behavior: 'smooth' });
        });

        // Event listener untuk navigasi ke quote berikutnya
        nextQuoteBtn.addEventListener('click', () => {
            quotesSlider.scrollBy({ left: quotesSlider.clientWidth, behavior: 'smooth' });
        });

        // Event listener untuk mengunduh quote
        downloadQuoteBtn.addEventListener('click', downloadCurrentQuote);

        // Event listener untuk membagikan quote
        shareQuoteBtn.addEventListener('click', shareCurrentQuote);

        // Event listener untuk submit email
        submitEmailBtn.addEventListener('click', submitEmail);

        // Tutup modal dengan mengklik overlay
        window.addEventListener('click', (e) => {
            if (e.target === confessModal) hideModal(confessModal);
            if (e.target === successModal) hideModal(successModal);
            if (e.target === errorModal) hideModal(errorModal); 
            if (e.target === talkToSelfieModal) hideModal(talkToSelfieModal); // NEW: Close talk to Selfie modal
        });

        // Talk to Selfie Event Listeners
        openTalkToSelfieModalBtn.addEventListener('click', () => {
            showModal(talkToSelfieModal);
            selfieChatInput.focus(); // Focus on input when modal opens
            chatHistoryDisplay.scrollTop = chatHistoryDisplay.scrollHeight; // Scroll to bottom
        });

        closeTalkToSelfieModalBtn.addEventListener('click', () => {
            hideModal(talkToSelfieModal);
        });

        sendSelfieMessageBtn.addEventListener('click', () => {
            sendMessageToSelfie(selfieChatInput.value);
        });

        selfieChatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessageToSelfie(selfieChatInput.value);
            }
        });

        // NEW: Event listener for confession text area character count
        const CONFESS_MAX_LENGTH = 500; // Max length for confession text
        modalConfessText.addEventListener('input', () => {
            const currentLength = modalConfessText.value.length;
            modalConfessCharCount.textContent = `${currentLength}/${CONFESS_MAX_LENGTH}`;
            if (currentLength >= CONFESS_MAX_LENGTH - 50) { // Warning 50 chars before limit
                modalConfessCharCount.classList.add('warning');
            } else {
                modalConfessCharCount.classList.remove('warning');
            }
        });


        // --- Initial Load ---
        // Authenticate user and then set up Firestore listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                console.log("Authenticated with Firebase. User ID:", userId);
                setupConfessionsListener(); // Start listening for confessions once authenticated
            } else {
                // Sign in anonymously if no user is logged in
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Error during anonymous sign-in:", error);
                    showErrorModal('Gagal melakukan autentikasi. Beberapa fitur mungkin tidak berfungsi.');
                    if (loadingMessage) loadingMessage.textContent = 'Gagal memuat pengakuan (autentikasi gagal).';
                }
            }
        });

        // Ensure the initial render of the slider is correct on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            setupQuotesSlider();
        });

    </script>
</body>
</html>
